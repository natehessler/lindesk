 

# Frontend is crashing with errors related to Dirty Database <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#5437](https://sourcegraph.zendesk.com/agent/tickets/5437)
- Application engineer: Michael Bali
- Customer: Mercari <!-- Redact if this contains personally identifying information -->
- Date: Jan 6, 2022

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.35.1​
- Deployment: kubernetes
- External Services: GITHUB
- Auth Providers: openidconnect


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/C018U1ZRFQC/p1641535950001100
- GitHub Issue Link: N/A
- Doc Update Link: N/A

## Summary
### Description of Customer Issue
The customer recently upgraded their Sourcegraph instance to 3.35 but the frontend is now crashing with the error stated in the error section

### Troubleshooting Steps
- Shared the [documentation](https://docs.sourcegraph.com/admin/how-to/dirty_database) that talks about solving the dirty database issue.
- The customer first reverted to 3.34.0 as temporary mitigation before retrying the upgrade process again.
- After running the query in the up migration file, the description of the index returned invalid.
- I asked that they drop and recreate the index.

```
sg=# DROP INDEX <name_of_index>;
DROP INDEX
sg=# CREATE INDEX CONCURRENTLY IF NOT EXISTS repo_hashed_name_idx
sg-#     ON repo USING btree (stars DESC NULLS LAST, id DESC) WHERE deleted_at IS NULL AND blocked IS NULL;
CREATE INDEX
sg=#

```
- then you can re-check ``` sg=# \d repo``` should no longer flag invalid.
- The customer can follow through with the remaining instructions in the documentation.

### Resolution
The [documentation](https://docs.sourcegraph.com/admin/how-to/dirty_database) helped resolve the issue.

### Relevant Docs Pages Used/Created
https://docs.sourcegraph.com/admin/how-to/dirty_database

### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->
```
t=2022-01-07T06:09:57+0000 lvl=info msg="Checked current version" schema=frontend version=1528395954 dirty=true

t=2022-01-07T06:09:57+0000 lvl=info msg="Checked current version" schema=frontend version=1528395954 dirty=true

ERROR: failed to connect to frontend database: dirty database: schema is marked as dirty but no migrator instance appears to be running

The target schema is marked as dirty and no other migration operation is seen running on this schema. The last migration operation over this schema has failed (or, at least, the migrator instance issuing that migration has died). Please contact support@sourcegraph.com for further assistance.
```

<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 5437.md -->
