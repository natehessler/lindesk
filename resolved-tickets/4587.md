

# Two Sourcegraph instances in the same cluster scraping each other metrics <!-- Ticket Title  Hint: include keywords to make it searchable -->



- Zendesk Link: [#4587](https://sourcegraph.zendesk.com/agent/tickets/4587)

- Application engineer: Michael Bali

- Customer: Reddit <!-- Redact if this contains personally identifying information -->

- Date: Nov 15, 2021


<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->

<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->



## Technical Environment

- Version: 3.32.0​

- Deployment: kubernetes

- External Services: GITHUB

- Auth Providers: builtin,GitHub





## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/C02BJ8T258D/p1637018351137800

- GitHub Issue Link: https://github.com/sourcegraph/customer/issues/582

- Doc Update Link: N/A



## Summary

### Description of Customer Issue

The customer set up an entire second Sourcegraph install in the same cluster as the existing install. The new install is intended to be their production instances. The issue the customer was having is that both installations are picking up each other's metrics and she would like to know if there is a way to have each Prometheus scrape only metrics for its namespace.
 

### Troubleshooting Steps
- I tried to find out what cadvisor config does.
- Basically what the customer is trying to achieve is called a multi-tenant cluster - We generally recommend against deploying Sourcegraph in a multi-tenant Kubernetes cluster as that increases the risks that Sourcegraph and your other services could run into resource constraints imposed by the other because the cadvisor is a deamonset and cannot be changed to a deployment.cadvisor is an official Google tool for collecting metrics such as CPU/memory/IO from the host node of Kubernetes clusters. It is required to be run as a daemonset because only one copy of it should run per host node, it cannot be a deployment by nature of what it does. It needs to run on every node that SG runs on in order for us to get the correct metrics. cAdvisor exports all of our metrics to Prometheus and Grafana.
 



### Resolution
- Ensure that both SG instances are properly configured to use their distinct namespaces by using a namespace overlay for sourcegraph. - We have some docs on this here: https://docs.sourcegraph.com/admin/install/kubernetes/overlays#namespaced-overlay
- check the metric_relabel_configs section in each instance configmap file in the Prometheus folder. uncommenting those 3 lines ensure that metrics for namespace A are kept.
- Run the command to see namespaces in the cluster. (kubectl get pods --namespace=prod -o=wide)
- check to see that metrics are now configured properly.



### Relevant Docs Pages Used/Created


- https://docs.sourcegraph.com/admin/install/kubernetes/configure#filtering-cadvisor-metrics
- https://docs.sourcegraph.com/dev/background-information/observability/cadvisor#known-issues


### Relevant Error / Logs

<!-- Please redact keys, tokens, and personal identifying information -->

N/A


<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 4587.md -->
