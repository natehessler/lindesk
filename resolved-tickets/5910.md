
# Kubernetes Upgrade permissions cadvisor prometheus problems<!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#5910](https://sourcegraph.zendesk.com/agent/tickets/5910)
- Application engineer: Giselle Northy
- Customer: Datasite <!-- Redact if this contains personally identifying information -->
- Date: Jan 31

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: ​3.32
- Deployment: Kubernetes
- External Services:
- Auth Providers:


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/C02PT5LK7C6/p1643653561374239
- GitHub Issue Link:
- Doc Update Link:

## Summary


### Customer Question

Running into these errors when upgrading from 3.32 to 3.33

```
  deploy-sourcegraph git:(release) ./overlay-generate-cluster.sh namespaced generated-cluster
➜  deploy-sourcegraph git:(release) kubectl apply -n sourcegraph --prune -l deploy=sourcegraph -f generated-cluster --recursive
daemonset.apps/cadvisor unchanged
deployment.apps/codeinsights-db configured
deployment.apps/codeintel-db configured
deployment.apps/github-proxy configured
deployment.apps/jaeger configured
deployment.apps/minio configured
deployment.apps/pgsql configured
deployment.apps/precise-code-intel-worker configured
deployment.apps/prometheus configured
deployment.apps/query-runner configured
deployment.apps/redis-cache configured
deployment.apps/redis-store configured
deployment.apps/repo-updater configured
deployment.apps/searcher configured
deployment.apps/sourcegraph-frontend configured
deployment.apps/symbols configured
deployment.apps/syntect-server configured
deployment.apps/worker configured
statefulset.apps/gitserver configured
statefulset.apps/grafana configured
statefulset.apps/indexed-search configured
Warning: networking.k8s.io/v1beta1 Ingress is deprecated in v1.19+, unavailable in v1.22+; use networking.k8s.io/v1 Ingress
ingress.networking.k8s.io/sourcegraph-frontend configured
role.rbac.authorization.k8s.io/sourcegraph-frontend unchanged
rolebinding.rbac.authorization.k8s.io/prometheus-nonprivileged configured
rolebinding.rbac.authorization.k8s.io/sourcegraph-frontend-nonprivileged configured
rolebinding.rbac.authorization.k8s.io/sourcegraph-frontend unchanged
configmap/codeinsights-db-conf unchanged
configmap/codeintel-db-conf unchanged
configmap/grafana unchanged
configmap/pgsql-conf unchanged
configmap/prometheus configured
persistentvolumeclaim/codeinsights-db unchanged
persistentvolumeclaim/codeintel-db unchanged
persistentvolumeclaim/minio unchanged
persistentvolumeclaim/pgsql unchanged
persistentvolumeclaim/prometheus unchanged
persistentvolumeclaim/redis-cache unchanged
persistentvolumeclaim/redis-store unchanged
service/backend unchanged
service/codeinsights-db unchanged
service/codeintel-db unchanged
service/github-proxy unchanged
service/gitserver unchanged
service/grafana unchanged
service/indexed-search-indexer unchanged
service/indexed-search unchanged
service/jaeger-collector unchanged
service/jaeger-query unchanged
service/minio unchanged
service/pgsql unchanged
service/precise-code-intel-worker unchanged
service/prometheus unchanged
service/query-runner unchanged
service/redis-cache unchanged
service/redis-store unchanged
service/repo-updater unchanged
service/searcher unchanged
service/sourcegraph-frontend-internal unchanged
service/sourcegraph-frontend unchanged
service/symbols unchanged
service/syntect-server unchanged
service/worker unchanged
serviceaccount/cadvisor unchanged
serviceaccount/grafana unchanged
serviceaccount/prometheus unchanged
serviceaccount/sourcegraph-frontend unchanged
Error from server (Forbidden): error when retrieving current configuration of:
Resource: "policy/v1beta1, Resource=podsecuritypolicies", GroupVersionKind: "policy/v1beta1, Kind=PodSecurityPolicy"
Name: "cadvisor", Namespace: ""
from server for: "generated-cluster/policy_v1beta1_podsecuritypolicy_cadvisor.yaml": podsecuritypolicies.policy "cadvisor" is forbidden: User "btobon-a@adminsys.mrll.com" cannot get resource "podsecuritypolicies" in API group "policy" at the cluster scope
Error from server (Forbidden): error when retrieving current configuration of:
Resource: "rbac.authorization.k8s.io/v1, Resource=clusterroles", GroupVersionKind: "rbac.authorization.k8s.io/v1, Kind=ClusterRole"
Name: "cadvisor", Namespace: ""
from server for: "generated-cluster/rbac.authorization.k8s.io_v1_clusterrole_cadvisor.yaml": clusterroles.rbac.authorization.k8s.io "cadvisor" is forbidden: User "btobon-a@adminsys.mrll.com" cannot get resource "clusterroles" in API group "rbac.authorization.k8s.io" at the cluster scope
Error from server (Forbidden): error when retrieving current configuration of:
Resource: "rbac.authorization.k8s.io/v1, Resource=clusterroles", GroupVersionKind: "rbac.authorization.k8s.io/v1, Kind=ClusterRole"
Name: "prometheus", Namespace: ""
from server for: "generated-cluster/rbac.authorization.k8s.io_v1_clusterrole_prometheus.yaml": clusterroles.rbac.authorization.k8s.io "prometheus" is forbidden: User "btobon-a@adminsys.mrll.com" cannot get resource "clusterroles" in API group "rbac.authorization.k8s.io" at the cluster scope
Error from server (Forbidden): error when retrieving current configuration of:
Resource: "rbac.authorization.k8s.io/v1, Resource=clusterrolebindings", GroupVersionKind: "rbac.authorization.k8s.io/v1, Kind=ClusterRoleBinding"
Name: "cadvisor", Namespace: ""
from server for: "generated-cluster/rbac.authorization.k8s.io_v1_clusterrolebinding_cadvisor.yaml": clusterrolebindings.rbac.authorization.k8s.io "cadvisor" is forbidden: User "btobon-a@adminsys.mrll.com" cannot get resource "clusterrolebindings" in API group "rbac.authorization.k8s.io" at the cluster scope
Error from server (Forbidden): error when retrieving current configuration of:
Resource: "rbac.authorization.k8s.io/v1, Resource=clusterrolebindings", GroupVersionKind: "rbac.authorization.k8s.io/v1, Kind=ClusterRoleBinding"
Name: "prometheus", Namespace: ""
from server for: "generated-cluster/rbac.authorization.k8s.io_v1_clusterrolebinding_prometheus.yaml": clusterrolebindings.rbac.authorization.k8s.io "prometheus" is forbidden: User "btobon-a@adminsys.mrll.com" cannot get resource "clusterrolebindings" in API group "rbac.authorization.k8s.io" at the cluster scope
```


### Application Engineer Answer

Thanks for checking that. I’ve got a couple ideas based on all the info so far. Since you’re using a non-default namespace sourcegraph and getting some (Forbidden): error from cadvisor and prometheus, I want to check how those namespaces were added…
These both have similar wording but for both cadvisor.ClusterRoleBinding.yaml and prometheus.ClusterRoleBinding.yaml the namespaces need to be changed directly or use the namespace overlay.
What we need to figure out is is how those files were set up before - some people edit the files directly, some don’t :woman-shrugging:
 

If you are deploying Sourcegraph to a non-default namespace, you’ll have to change the namespace specified in cadvisor.ClusterRoleBinding.yaml to the one that you created. You can do this by editing the namespace directly, or by using the namespaced overlay.

https://github.com/sourcegraph/deploy-sourcegraph/tree/master/base/prometheus#namespaces
https://github.com/sourcegraph/deploy-sourcegraph/tree/master/base/cadvisor#namespaces

So let’s check what’s in the existing install directory and cat a couple yamls to see everything included in these files:cat namespaced/cadvisor/cadvisor.ClusterRoleBinding.yaml
`cat namespaced/prometheus/prometheus.ClusterRoleBinding.yaml`
`cat namespaced/kustomization.yaml`

Customer confirmed he did manually change the files. Instead he should have edited them in the overlays.
He also has some permissions issues going on.
He also was failing to run the overlay commands before upgrade script.


### Relevant Docs Pages Used/Created

https://github.com/sourcegraph/deploy-sourcegraph/blob/master/overlays/namespaced/README.md
https://github.com/sourcegraph/deploy-sourcegraph/blob/master/overlays/namespaced/kustomization.yaml
https://github.com/sourcegraph/deploy-sourcegraph/blob/master/base/frontend/sourcegraph-frontend.Ingress.yaml
https://handbook.sourcegraph.com/departments/support/process/managing-cs-k8s
https://stackoverflow.com/questions/68676805/solved-kubectl-user-systemnodeanth-admin-host1-cannot-list-resource-ev
https://docs.sourcegraph.com/admin/install/kubernetes/troubleshoot
https://github.com/sourcegraph/deploy-sourcegraph/tree/master/base/cadvisor
https://github.com/sourcegraph/deploy-sourcegraph/tree/master/base/prometheus#namespaces

<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 5910.md -->
