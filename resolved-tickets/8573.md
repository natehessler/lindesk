
# Code Intel Restarts frequently after enabling RockSkip <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#8573](https://sourcegraph.zendesk.com/agent/tickets/8573)
- Application engineer: Michael Bali
- Customer: Nutanix, Inc. <!-- Redact if this contains personally identifying information -->
- Date: May 30, 2022

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.34.2​
- Deployment: kubernetes
- External Services: GITHUB,OTHER
- Auth Providers: builtin,saml


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/C02BQBNJVL0/p1653959717867999
- GitHub Issue Link: N/A
- Doc Update Link: N/A

## Summary
### Description of Customer Issue
Code Intel Restarts frequently After enabling RockSkip

### Troubleshooting Steps
- Requested for a  describe pod for codeintel or pgsql.
- Requested for grafana chart for the memory usage of both the code intel Db and pgsql DB
- Requested for logs from the postgres pod.
- We see some corruption in the code intel DB 
- Frequent alert for transaction duration on pgsql pods ["[CRITICAL] postgres: 0.5s+ maximum transaction durations for 10m0s"](https://docs.sourcegraph.com/@v3.38.1/admin/observability/alert_solutions#postgres-transaction-durations)
- Needed to find out  where rockskip is writing on which database, codeintel or main pgsql
- We tuned readiness and liveness probe, still issue persist
- We also need to find the reason behind sudden increase in memory utilization for pgsql.

### Resolution
Chris from Code intel had to step in.
- Rockskip connects to the code intel-DB not the front end
- To stop RockSkip Indexing and Delete Rockskip index.
         - Set `USE_ROCKSKIP=false` on the `symbols` container then restart it.
         - Run `TRUNCATE rockskip_repos, rockskip_ancestry, rockskip_symbols;` on the codeintel-db

Likely root cause: codeintel-db did not have enough RAM to use Rockskip.

Longer explanation:
Enabling Rockskip added memory pressure to the `codeintel-db` Postgres instance and pushed the memory usage to its limit of 4GB.
K8s then OOM killed `codeintel-db` and created a new pod, sending Postgres into recovery mode.
Postgres was unable to recover within the 1-minute liveness/readiness probe deadline (15s initial delay + 3*15s retries), so k8s killed it again and entered an infinite kill+restart loop.

Other notes:
- The Rockskip tables are using 11GB of disk in Postgres
- After recovery, the biggest Postgres process is using 52MB of RAM
- Nutanix disabled Rockskip indexing in order to avoid putting load on the `codeintel-db`
- Nutanix is leaving the Rockskip tables alone (not truncating)

Action items:
- DONE: will run some benchmarks to estimate the RAM requirements of `codeintel-db` and post back in this thread so that Nutanix can (hopefully) reduce the current RAM request of 32GB and enable Rockskip again
- DONE: see [PR](https://github.com/sourcegraph/deploy-sourcegraph/pull/4136) will propose an increase to the lenience of the liveness and readiness probes for `codeintel-db` in the k8s YAML files to help Postgres instances recover in the future without the manual intervention needed in this case.

Here's the Rockskip RAM benchmark methodology:
- I had Rockskip index 116K of the 600K total commits of https://github.com/sgtest/megarepo over 6 hours locally on my mac (I stopped it because I didn't see any upward trend in RAM usage)

Results:
- RAM usage went from 250MB before indexing -> 1100MB during indexing -> 250MB after indexing.
- I then ran Rockskip on 2K commits of https://github.com/sourcegraph/sourcegraph and the RAM usage pattern looked the same
- I then ran Rockskip on both repos at the same time and the RAM usage pattern averaged a bit higher at 900MB but peaked at the same 1.1GB (second screenshot).
- I also ran 5 queries/sec for 5 minutes and the RAM and CPU usage didn't seem to change much at all

Conclusions:
- Peak RAM usage during indexing is roughly 1GB on top of idle RAM usage
- Average RAM usage increases as indexing concurrency increases (default limit is 4 repos at a time)
- RAM usage is independent of the number of commits in the repo
- RAM usage is independent of the number of files in the repo
-  `codeintel-db` should be given a few extra GB of RAM when enabling Rockskip

### Relevant Docs Pages Used/Created
- https://github.com/sourcegraph/deploy-sourcegraph/pull/4136
- https://github.com/sourcegraph/customer/issues/976

### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->
`psql: error: FATAL:  the database system is starting up`

<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 8573.md -->
