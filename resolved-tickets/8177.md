
# Duplicate index errors <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#8177](https://sourcegraph.zendesk.com/agent/tickets/8177)
- Application engineer: Gabe Torres
- Customer: Reddit <!-- Redact if this contains personally identifying information -->
- Date: May 12

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.36.2​
- Deployment: kubernetes
- External Services: GITHUB
- Auth Providers: builtin,github


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/C02BJ8T258D/p1652372288083059 
- GitHub Issue Link: https://github.com/sourcegraph/customer/issues/950 
- Doc Update Link:

## Summary
### Description of Customer Issue
The customer was seeing errors in repo-updater and the frontend, and LSIF uploads were failing.

### Troubleshooting Steps
We ran pg_dump --schema-only to cross-reference their schema to a fresh schema and noticed that their schema was missing indexes and constraints.
We identified that there were several tables that had duplicate data. We think it came from repeatedly running an INSERT-based backup/restore process as part of their migration over to RDS.

### Resolution
We worked on a pattern to remove duplicate data and run a repair script that Eric put together (in GHI).

### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->
`Upload failed to complete: Store.UpdateReferenceCount: ERROR: column "u.committed_at" must appear in the GROUP BY clause or be used in an aggregate function (SQLSTATE 42803)`

`{"commit":"1f27ec716ec13edad539fe55041899ec8595d1b7","count":1,"elapsed":0.011594041,"error":"dbstore.MarkRepositoryAsDirty: ERROR: there is no unique or exclusion constraint matching the ON CONFLICT specification (SQLSTATE 42P10)","exactPath":true,"indexer":"","lvl":"eror","msg":"codeintel.resolvers.findClosestDumps","path":"ad_injector/service/service.go","repositoryID":725,"severity":"ERROR","t":"2022-05-12T22:17:13.247738922Z"}`

`{"count":1,"elapsed":0.000529465,"error":"ERROR: there is no unique or exclusion constraint matching the ON CONFLICT specification (SQLSTATE 42P10)","lvl":"eror","msg":"codeintel.dbstore.MarkRepositoryAsDirty","repositoryID":725,"severity":"ERROR","t":"2022-05-12T22:27:53.733264888Z"}`


<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 8177.md -->
