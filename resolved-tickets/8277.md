
# apple-spg - upgrade fails <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#8277](https://sourcegraph.zendesk.com/agent/tickets/8277)
- Application engineer: Warren Gifford
- Customer: Apple <!-- Redact if this contains personally identifying information -->
- Date: May 17, 2022

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.32.0​
- Deployment: docker-container
- External Services: OTHER
- Auth Providers: saml


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/C0225J36ZTR/p1652841688760229
- GitHub Issue Link: https://github.com/sourcegraph/customer/issues/991
- Doc Update Link:

## Summary
### Description of Customer Issue

Upgrade of a single container docker image running in a k8s cluster fails due to code-insights db initializing incorrectly 

### Troubleshooting Steps

warrengifford@Warrens-MacBook-Pro ~ % docker run -d --publish 7080:7080 --publish 127.0.0.1:3370:3370 -e ALLOW_SINGLE_DOCKER_CODE_INSIGHTS=false --rm --volume ~/.sourcegraph/config:/etc/sourcegraph --volume ~/.sourcegraph/data:/var/opt/sourcegraph sourcegraph/server:3.38.0
24b2dfeb29e730145d4593aeea40295dbea01fcc5a6d879687f45ea469d5836e
warrengifford@Warrens-MacBook-Pro ~ % docker ps
CONTAINER ID   IMAGE                       COMMAND                  CREATED         STATUS         PORTS                                              NAMES
24b2dfeb29e7   sourcegraph/server:3.38.0   "/sbin/tini -- /usr/…"   4 seconds ago   Up 4 seconds   127.0.0.1:3370->3370/tcp, 0.0.0.0:7080->7080/tcp   jovial_booth
warrengifford@Warrens-MacBook-Pro ~ % docker container exec -it 24b2dfeb29e7 sh -c 'env'
HOSTNAME=24b2dfeb29e7
ALLOW_SINGLE_DOCKER_CODE_INSIGHTS=false
SHLVL=1
HOME=/root
TERM=xterm
GO111MODULES=on
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
LANG=en_US.utf8
PWD=/
MINIO_VERSION=RELEASE.2021-12-10T23-03-39Z
warrengifford@Warrens-MacBook-Pro ~ % docker ps
CONTAINER ID   IMAGE                       COMMAND                  CREATED         STATUS         PORTS                                              NAMES
24b2dfeb29e7   sourcegraph/server:3.38.0   "/sbin/tini -- /usr/…"   4 minutes ago   Up 4 minutes   127.0.0.1:3370->3370/tcp, 0.0.0.0:7080->7080/tcp   jovial_booth
warrengifford@Warrens-MacBook-Pro ~ % docker kill 24b2dfeb29e7
24b2dfeb29e7
warrengifford@Warrens-MacBook-Pro ~ % docker run -d --publish 7080:7080 --publish 127.0.0.1:3370:3370 -e ALLOW_SINGLE_DOCKER_CODE_INSIGHTS=false --rm --volume ~/.sourcegraph/config:/etc/sourcegraph --volume ~/.sourcegraph/data:/var/opt/sourcegraph sourcegraph/server:3.39.0
e959da140eabac870af7687a71bc0c8865016eb3e695de1b2546453f023f6725
warrengifford@Warrens-MacBook-Pro ~ % docker ps
CONTAINER ID   IMAGE                       COMMAND                  CREATED         STATUS         PORTS                                              NAMES
e959da140eab   sourcegraph/server:3.39.0   "/sbin/tini -- /usr/…"   7 seconds ago   Up 6 seconds   127.0.0.1:3370->3370/tcp, 0.0.0.0:7080->7080/tcp   crazy_goodall
warrengifford@Warrens-MacBook-Pro ~ % docker logs e959da140eab
✱ Sourcegraph is creating missing databases sourcegraph-codeinsights... (may take 15-20 seconds)
✱ Finished initializing the internal database.
Starting postgres processes
Starting migrator
03:15:48 postgres | 2022-05-23 03:15:48.936 UTC [38] LOG:  starting PostgreSQL 12.10 on x86_64-alpine-linux-musl, compiled by gcc (Alpine 9.3.0) 9.3.0, 64-bit
t=2022-05-23T03:15:49+0000 lvl=info msg="Desugaring `upgrade` to `targeted up` operation" schema=frontend leafVersions="[1649441222 1649759318 1649432863]"
t=2022-05-23T03:15:49+0000 lvl=info msg="Checked current schema state" schema=frontend appliedVersions=[] pendingVersions=[] failedVersions=[]
t=2022-05-23T03:15:49+0000 lvl=warn msg="Schema not in expected state" schema=frontend appliedVersions=[] pendingVersions=[] failedVersions=[] targetDefinitions="[1647849753 1647860082 1648051770 1648115472 1648195639 1648524019 1648628900 1649269601 1649441222 1649759318 1649432863]"
t=2022-05-23T03:15:49+0000 lvl=info msg="Checking for active migrations" schema=frontend
t=2022-05-23T03:15:49+0000 lvl=info msg="Acquired schema migration lock" schema=frontend
t=2022-05-23T03:15:49+0000 lvl=info msg="Checked current schema state" schema=frontend appliedVersions=[] pendingVersions=[] failedVersions=[]
t=2022-05-23T03:15:49+0000 lvl=info msg="Applying migrations" schema=frontend up=true count=11
t=2022-05-23T03:15:49+0000 lvl=info msg="Applying migration" schema=frontend migrationID=1647849753 up=true
t=2022-05-23T03:15:49+0000 lvl=info msg="Applying migration" schema=frontend migrationID=1647860082 up=true
t=2022-05-23T03:15:49+0000 lvl=info msg="Applying migration" schema=frontend migrationID=1648051770 up=true

...

warrengifford@Warrens-MacBook-Pro ~ % docker exec -it e959da140eab sh -c 'env'
HOSTNAME=e959da140eab
ALLOW_SINGLE_DOCKER_CODE_INSIGHTS=false
SHLVL=1
HOME=/root
TERM=xterm
GO111MODULES=on
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
LANG=en_US.utf8
PWD=/
MINIO_VERSION=RELEASE.2021-12-10T23-03-39Z


This was tested extensively and eventually the customer was advised to set up a volume to pipe the failing postgres container logs too
Hey @Maray Elammari I've attempted a number of tests to reproduce this issue on test instances via a docker-compose style deployment of the Sourcegraph server. I'll continue trying, but also it would be good if we could attempt to get the postgres logs from the failing codeingishts_db initializationCould you create a volume mount in your compose file so that we can persist those logs?On the host machine --
mkdir ~/.sourcegraph/tmp
chmod 1777 ~/.sourcegraph/tmp

Then in your compose file, add the following volume mount
volumes:
      - ~/.sourcegraph/tmp:/tmp

If you try to upgrade again and it fails we should be able to take a look at the db failure logs there. Let me know if you try this out or if you try out the fake env var from above


[codestage@code-search-app tmp]$ sudo more pgsql.log
2022-06-08 16:59:00.172 UTC [24] LOG:  starting PostgreSQL 12.10 on x86_64-alpine-linux-musl, compiled by gcc (Alpine 9.3.0) 9.3.0,
64-bit
2022-06-08 16:59:00.172 UTC [24] LOG:  could not bind IPv4 address "127.0.0.1": Permission denied
2022-06-08 16:59:00.172 UTC [24] HINT:  Is another postmaster already running on port 443? If not, wait a few seconds and retry.
2022-06-08 16:59:00.172 UTC [24] WARNING:  could not create listen socket for "127.0.0.1"
2022-06-08 16:59:00.172 UTC [24] FATAL:  could not create any TCP/IP sockets
2022-06-08 16:59:00.172 UTC [24] LOG:  database system is shut down


### Resolution

This issue was resolved with a PR that prevents the db from initializing in single container deployments
https://github.com/sourcegraph/sourcegraph/issues/36746

### Relevant Docs Pages Used/Created

### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->


<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 8277.md -->
