
# Kubernetes deployment using insiders images <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#5425](https://sourcegraph.zendesk.com/agent/tickets/5425)
- Application engineer: Gabe Torres
- Customer: eBay <!-- Redact if this contains personally identifying information -->
- Date: Jan 6

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.25.2​
- Deployment: kubernetes
- External Services: GITHUB
- Auth Providers: builtin,github


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/C01BT374HHV/p1641497631001700 
- GitHub Issue Link:
- Doc Update Link:

## Summary
### Description of Customer Issue
The customer added an external code host but they were seeing "Can't connect to GitHub" on the code host status.

### Troubleshooting Steps
I tested the external host config, the user was able to update the settings without errors.
We checked the repo setting and we saw that all the repos were showing up as "Empty repository".
We saw in grafana that gitserver, worker, and indexed search pods were unavailable.
I saw in the index server logs that the index service could not connect to the frontend.
I thought this was an RBAC issue so I asked for a deployment spec and saw that the admin was using the insiders images for all the services.

### Resolution
The admin was updating his instance by pulling the insiders images from DockerHub and some of the images were incompatible. This can happen when users deploy the main branch instead of checking out the versioned tag. We recommend following the standard upgrade path to make upgrades easier and prevent future issues as services change or get removed. The important part is to get the new changes from the release tags. 

### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->
`gitserver: less than 90% percentage pods available for 10m0s`
`worker: less than 1 number of worker instances running the codeintel-janitor job for 5m0s`
`t=2022-01-07T19:27:50+0000 lvl=eror msg="Syncing repo state" error ="fetching gitserver status: ERROR: column gr.last_external_service does not exist (SQLSTATE 42703)"`
`2022/01/06 22:44:02 POST http://sourcegraph-frontend-internal/.internal/repos/index giving up after 5 attempts`

<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 5425.md -->
