# Booking.com Question <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#8100](https://sourcegraph.zendesk.com/agent/tickets/8100)
- Application engineer: Stomzy Mwendwa
- Customer: Booking.com <!-- Redact if this contains personally identifying information -->
- Date: May 10

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.37.0â€‹
- Deployment: kubernetes
- External Services: GITLAB
- Auth Providers: gitlab


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/C024D1ESXUH/p1652191545348879 
- GitHub Issue Link: N/A
- Doc Update Link: N/A

## Summary
### Description of Customer Issue
The customer ran into this error: error: failed to run migration for schema "frontend": dirty database: schema "frontend" marked the following migrations as failed: 1647282553 

When running the manual schema change, the customer ran into:
when we did the manual apply the schema change, we got the deadlock issue:
sg=# DROP VIEW IF EXISTS external_service_sync_jobs_with_next_sync_at;
ERROR:  deadlock detected
DETAIL:  Process 14034 waits for AccessExclusiveLock on relation 17778 of database 16384; blocked by process 33.
Process 33 waits for AccessShareLock on relation 17756 of database 16384; blocked by process 14034.
HINT:  See server log for query details.

### Troubleshooting Steps
select * from pg_locks to see which processes are causing conflict with context deadlines/deadlocks

Scale services that are related to these processes to 0 and apply the manual migration sql commands
### Resolution
We scaled down the frontend, precise-intel-worker, worker and repo-updater services which were causing the postgres locks. 

Once that was done, we were able to apply the manual migration done. 
### Relevant Docs Pages Used/Created
https://docs.sourcegraph.com/admin/how-to/manual_database_migrations#kubernetes 
https://github.com/sourcegraph/sourcegraph/tree/main/migrations/frontend/1647282553 
### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->
