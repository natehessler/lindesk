
# Inconsistent search results + repos not syncing correctly <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#8339](https://sourcegraph.zendesk.com/agent/tickets/8339)
- Application engineer: Gabe Torres
- Customer: Vmware <!-- Redact if this contains personally identifying information -->
- Date: May 19, 2022

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: ​3.40.0
- Deployment: Docker Compose
- External Services: Gitlab
- Auth Providers: Gitlab
 
## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/C03DYKCM3PD/p1653413483356449 
- GitHub Issue Link: https://github.com/sourcegraph/customer/issues/975 
- Doc Update Link:

## Summary
### Description of Customer Issue
The customer's repos were disappearing from the frontend and re-adding the code host connection would temporarily make the repos appear. 

### Troubleshooting Steps
We looked at repos for repo updater and gitserver. We checked the database for the total number of repos. We saw a 401 error in the repo updater logs and tied this issue back to the incident with expiring Gitlab Oauth tokens. 

### Resolution
This was fixed in the 3.40.1 patch. https://github.com/sourcegraph/sourcegraph/pull/36003 

### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->
`t=2022-05-24T17:16:50+0000 lvl=dbug msg="TRACE gitlab" host=gitlab.customer.com path=/api/v4/projects code=401 duration=116.643979ms`  
`t=2022-05-24T17:16:50+0000 lvl=dbug msg=PermsSyncer.fetchUserPermsViaExternalAccounts.setExternalAccountExpired userID=6 id=5 unauthorized=true accountSuspended=false forbidden=false`


<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 8339.md -->
