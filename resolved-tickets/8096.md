
# Googlr SMTP relay does not work <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#8096](https://sourcegraph.zendesk.com/agent/tickets/8096)
- Application engineer: Michael Bali
- Customer: <!-- Redact if this contains personally identifying information -->
- Date: May 9, 2022

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: ​v3.39.1
- Deployment:
- External Services:
- Auth Providers:


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph-community.slack.com/archives/C02BG0M0ZJ7/p1652159759607939
- GitHub Issue Link: https://github.com/sourcegraph/sourcegraph/issues/35943
- Doc Update Link:

## Summary
### Description of Customer Issue
I'm running on Google Compute Engine on a Container Optimized OS VM. Got everything working except I'm having difficulty getting SMTP set up though google workspace's smtp-relay. When I run a `sendTestEmail` command, I get back an opaque error:
```
{
"data": {
"sendTestEmail": "Failed to send test email: EOF"
}
}

```

Here is a redacted snippet of my config:
```
"email.address": "MANUALLYREDACTED",
"email.smtp": {
"authentication": "PLAIN",
"domain": "MANUALLYREDACTED",
"username": "MANUALLYREDACTED",
"password": "REDACTED",
"host": "http://smtp-relay.gmail.comsmtp-relay.gmail.com>",
"port": 587
}

```


### Troubleshooting Steps
- I asked that he telnet from the server to the SMTP host and he got a response. So that worked. Still, he is unable to send test emails.
- I checked to see if 2FA is enabled on the Google workspace account because when its enabled SMTP does not work and the customer confirmed 2FA is off.

- I requested for logs and in the frontend we saw this error  `frontend | t=2022-05-11T16:43:49+0000 lvl=warn msg="Failed to send email to inform user of access token creation" error=EOF` which originated from [here](https://sourcegraph.com/github.com/sourcegraph/sourcegraph/-/blob/cmd/frontend/graphqlbackend/access_tokens.go?L92:15),

- I told the user to create an access token on their instance and attempt again, but no dice!

- I also confirmed that `Require SMTP Authentication` and `Require TLS encryption` in step 7 are enabled according to the [SMTP relay account](https://support.google.com/a/answer/2956491) doc .

- I was able to reproduce the issue on my end and I discoveredwhen I use  `“host”: “smtp-relay.gmail.com”`,It throws the error the user is seeing. However when I use `host”: “smtp.gmail.com”` it works.

### Resolution
The Team responsible for this bit of the product is currently looking into this as we think it's an issue getting SMTP relay to work with sourcegraph and you can follow along [here](https://github.com/sourcegraph/sourcegraph/issues/35943) as we investigate.
At the moment, The alternative is to use `“host”: “smtp.gmail.com”` while we figure this out.

### Relevant Docs Pages Used/Created
- https://github.com/sourcegraph/sourcegraph/issues/35943
### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->
`"Failed to send test email: EOF"`


<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 8096.md -->
