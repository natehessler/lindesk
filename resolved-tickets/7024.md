
# G3 Code Intelligence Extensions not Showing Up <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#7024](https://sourcegraph.zendesk.com/agent/tickets/7024)
- Application engineer: Kelvin Lee
- Customer: G3 Technologies, Inc. <!-- Redact if this contains personally identifying information -->
- Date: Mar 18

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.37.0
- Deployment: docker-compose
- External Services: Perforce
- Auth Providers: none known


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: None for customer, but [internal alignment thread here](https://sourcegraph.slack.com/archives/C01HW836940/p1649110671403379)
- GitHub Issue Link: [RFH](https://github.com/sourcegraph/customer/issues/784), and [public pull request](https://github.com/sourcegraph/src-cli/pull/718)
- Doc Update Link: None, but documentation surely needs improvement, as alluded in the [internal alignment slack thread](https://sourcegraph.slack.com/archives/C01HW836940/p1649124005295929?thread_ts=1649110671.403379&cid=C01HW836940) mentioned.

## Summary
### Description of Customer Issue
Air-gapped private extension registry is having issues. The extensions appeared to still be trying to reach out to sourcegraph.com, despite the customer havving followed some of our internal instructions on how to get a private extension registry working. 

Turns out... we might not support this fully/properly.

### Troubleshooting Steps

- Generic question that's usually good to ask: Were things working before and broke? Or is this the first time?
- Adding following site-configuration option, and then restarting the instance just in case, has worked for other resolved tickets mentioning private extension registries:
  ``` 
  {
    "extensions": { "remoteRegistry": false }
  }
  ```
  But did not for this customer.
- Getting the customer to visit `<the sourcegraph url>/extensions` and checking that at least a subset of the expected extensions are surfacing is a good way to check at least a subset of extensions are being found
- One can also check with the customer if the list returned by `src extensions list` is the expected _full_ list of extensions. Make sure they know how to use `src` (specifically, they are `src login'd to their instance, and not the default sourcegraph.com). Detail on `src login` [here](https://docs.sourcegraph.com/cli/references/login)
- Tried having the customer clear their cache, to see if, somehow, the extension was trying to reach out to sourcegraph.com due to cache reasons. Clearing the cache did not help/improve anything for this customer.
- Checking for an `externalURL` that has been properly customized/changed is a good place to check for extensions. `externalURL` is relied upon to create the `BundleURL` of an extension, which is where the extension will try to reach for resources. For this customer, their `externalURL` had already been properly customized, so thumbs up there.

Now, here are the key troubleshooting steps for this situation:
- `src extension get <extension-id>` will output the full JSON respresentation (manifest?) of the extension. An example of this call is `src extensions get sourcegraph/git-extras`.
  - One will notice that the output is... typically large, if the extension was already published, due to the "Raw" field. One can cut down the output to something read-able by doing `src extensions get <extension-id> | grep -v '"Raw"'`.
  - The key point of information in this JSON respresentation is the `BundleURL`, which is where the extension will try to reach out to as a resource.
  - For this customer, the `BundleURL` was revealed to still be going to a resource at `sourcegraph.com`. This simply won't work for an air-gapped instance.

Ultimately, this^ troubleshooting step, coupled with a lengthy investigation, led to acknowledge product/feature-gap, a code fix, etc.

### Resolution
Product/feature gap acknowledged as [issue](https://github.com/sourcegraph/customer/issues/784#issuecomment-1081040192). [Pull request](https://github.com/sourcegraph/src-cli/pull/718) made here.

Workarounds: None. None of the reasonably available + publicly documented flows can bypass this. We _do_ have like scripts and dev tools, but... not ready to recommend these.

Future work: There seem to be many flows available, and all have their own issues:
- https://docs.sourcegraph.com/extensions/authoring/forking
- https://docs.sourcegraph.com/admin/extensions#publish-extensions-to-a-private-extension-registry
- https://github.com/sourcegraph/code-intel-extensions#generating--publishing-extensions
- https://github.com/sourcegraph/sourcegraph-extensions-cloning-scripts
Issues include: poor understandability (old documentation), and `npm` vulnerabilities/issues.

Either these flows need to be consolidated, or their technical differences/nuances need to be made clear.

### Relevant Docs Pages Used/Created
- https://docs.sourcegraph.com/admin/config/site_config#extensions
- https://docs.sourcegraph.com/admin/extensions#use-extensions-from-sourcegraph-com-or-disable-remote-extensions
- https://docs.sourcegraph.com/extensions/authoring/forking
- https://docs.sourcegraph.com/admin/extensions#publish-extensions-to-a-private-extension-registry
- https://github.com/sourcegraph/code-intel-extensions#generating--publishing-extensions
- https://github.com/sourcegraph/sourcegraph-extensions-cloning-scripts
- https://docs.sourcegraph.com/cli/references/extensions/copy
- https://docs.sourcegraph.com/cli/references/extensions/publish


### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->
 “No information from extensions available.  Find extensions in the Sourcegraph extension registry”.

`The resource at "https:///sourecegraph.com/-/static/extension...." preloaded with link preload..."` <- This is the browser/client trying to reach out to sourcegraph.com for a resource. The exention was still configured to reach out to sourcegraph.com. The extension was like this because our instructions/code for private extension registries in air-gapped instances is incomplete/not providing the desired functionality.

`crypto.subtle is undefined`

<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 7024.md -->
