
# repo is searchable on sourcegraph.com but can't be found in the self-hosted instance by non-admin users <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#7939](https://sourcegraph.zendesk.com/agent/tickets/7939)
- Application engineer: Michael Bali
- Customer: Unity <!-- Redact if this contains personally identifying information -->
- Date: May 1

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.36.2​
- Deployment: kubernetes
- External Services: GITHUB,GITLAB
- Auth Providers: builtin,saml


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/C01FXGSJW5R/p1651460671814829
- GitHub Issue Link: https://github.com/sourcegraph/customer/issues/929#
- Doc Update Link: N/A

## Summary
### Description of Customer Issue
- Trying to search for `--all-versions` results in an error.
- Repo is searchable on `sourcegraph.com` but can't be found in the self-hosted instance by non-admin users

 <!-- Ticket Title  Hint: include keywords to make it searchable . -->

### Troubleshooting Steps
- I looked up the [error](https://sourcegraph.com/github.com/sourcegraph/sourcegraph/-/blob/client/web/src/search/results/sidebar/Revisions.tsx?L82:34), looks like sourcegraph is trying to get gitrefs that do not exist.
- Searching using the cli returns results, The Sourcegraph UI uses the [stream APi](https://docs.sourcegraph.com/api/stream_api) to execute interactive search while the src cli uses the [graphql API](https://docs.sourcegraph.com/api/graphql) by default when searching I guess this explains the difference in results.
- From the result of your search in the CLI I see the '--all-v' is present in the some repos.
- Requested for logs from the `frontend`  and `indexed search` pod.
- The customer could not access the repo in their self-hosted instance but on sourcegraph web.
- Checked to know if the users have permission to access these repos in their code host. Confirmed they have.
- The indexed-searcher pod was low on space.
- Requested site admin config.
the admin also said they have an internal service that reconciles this permissions on their end and think this is a bug


### Resolution
- The admin increased the resource allocated for indexed-searcher pod 
- In the site config, we noticed they have [Explicit permissions API](https://docs.sourcegraph.com/admin/repo/permissions#explicit-permissions-api) enabled. With this configuration, Sourcegraph exposes a GraphQL API to explicitly set repository permissions as an alternative to the code-host-specific repository permissions sync mechanisms. If the permissions API is enabled, all other repository permissions mechanisms are disabled (site admins bypass all permissions checks and can always view all repositories). This explains why site admins only have access to the repo.

### Relevant Docs Pages Used/Created
- https://docs.sourcegraph.com/admin/repo/permissions#explicit-permissions-api
- https://docs.sourcegraph.com/api/graphql
- https://docs.sourcegraph.com/api/stream_api
### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->
`Error: Unable to fetch repo revisions.`

<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 7939.md -->
