
# auth login issues / context missing state value / oauth2 <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#6794](https://sourcegraph.zendesk.com/agent/tickets/6794)
- Application engineer: Kelvin Lee
- Customer: Snapdocs Inc <!-- Redact if this contains personally identifying information -->
- Date: Mar 10

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.35.1​
- Deployment: kubernetes
- External Services: GITHUB
- Auth Providers: builtin,github


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: [Slack](https://sourcegraph.slack.com/archives/C029VE4A12R/p1646941079822639?thread_ts=1646940663.902629&cid=C029VE4A12R)
- GitHub Issue Link: Many related ones, shared below
- Doc Update Link: None

## Summary
### Description of Customer Issue
During the login flow via GitHub (and that I would guess is possible via any external auth service e.g. GitLab), users report they land on `<externalURL>/.auth/github/callback?code=<code>&state=<state>`, and the UI reports , `oauth2: Context missing state value`. This does not happen for all users, but instead a subset. This subset of users seems to report it consistently. Oddly, the users are able to still get into the Sourcegraph product aftewards. Basically, just a hiccup of the login flow that is non-blocking to using Sourcegraph.

### Troubleshooting Steps
- Tried getting sourcegraph-frontend-* logs, but they don't report any useful information
- Tried to grab info about the users to differentiate them, but that didn't report any useful differentiating information. Query in case you curious:
```
query{
 users{
  nodes {
    id,
    username,
    displayName,
    url,
    builtinAuth,
    siteAdmin,
    organizations{
      nodes {
        id,
        name,
        displayName
      }
    },
    emails {
      email,
      verificationPending
    }
  }
}
}
```

- Checked `auth.providers`, but it wasn't useful (everything looked correct)


### Resolution
Doing research, it's probably just a versioning issue. Lots of reports of this have been made before. They seemed like old'ish issues. Hopefully they get resolved by an upgrade. The history of reports:
- https://github.com/sourcegraph/sourcegraph/issues/3917#issuecomment-494165200
- https://github.com/sourcegraph/sourcegraph/issues/2263
- https://github.com/sourcegraph/customer/issues/674 (customer repo)
- https://github.com/sourcegraph/customer/issues/105  (customer repo)
- https://github.com/sourcegraph/sourcegraph/pull/14610

**Recommended an upgrade. No feedback yet if it actually succeeds, but customer appreciated the recommendation.**

### Relevant Docs Pages Used/Created

### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->

The most pertintent: 
`oauth2: Context missing state value`

Others that one might run into while testing, but that do not come up for this ticket:
- `Authentication failed. Try signing in again (and clearing cookies for the current site). The error was: coult not decode OAuth state from URL parameter` Seems to occur if you mess with the state= value in the URL
- `Could not verify user is part of the allowed GitHub organizations` Seems to occur if your GitHub account isnt in the allowed orgs from the site-config
- 
```
oauth2: error in token fetch response: bad_verification_code
error_description: The code passed is incorrect or expired
```

Seems to happen if refreshing the /.auth/github/callback/code=<>&state=<> page after an initial failure to auth, or something like that.

<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 6794.md -->
