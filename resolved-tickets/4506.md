

# Problem with upgrade from 3.30.4 to 3.31.2 <!-- Ticket Title  Hint: include keywords to make it searchable -->



- Zendesk Link: [#4506](https://sourcegraph.zendesk.com/agent/tickets/4506)

- Application engineer: Jason Harris

- Customer: Capital One <!-- Redact if this contains personally identifying information -->

- Date: Nov 9


<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->

<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->



## Technical Environment

- Version: ​`3.30.4`

- Deployment: k8s

- External Services:

- Auth Providers:





## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/C01QNMSLTFZ/p1636480085013600 

- GitHub Issue Link:

- Doc Update Link:



## Summary

### Description of Customer Issue



The customer attempted to upgrade from `3.30.4` to `3.31.2` and we were met with a `"could not create lock file"` error message caused by trying to act upon a read-only file system.



### Troubleshooting Steps

- Asked them to check for corrupt postgres indexes, but since they couldn't spin up the pods, they couldn't `exec` into the databases.
- Asked them to send their yaml files to check the security context.
- Asked if they were receiving an error that looked anything like this: `chmod: /var/run/postgresql: Operation not permitted`
- Asked if other DB's were starting up... answer was no.
- Asked for the output of `kubectl get pod codeinsights-db-6ffdb467f5-x6jrn -o yaml` and `kubectl get -A Mutatingwebhookconfigurations`.
  - Nothing of note output from these commands.
- Asked them to change security overlay settings, which only caused validation errors.
- Asked them to reboot `pgsql` pod, nothing.
- Suspected the pod was belonging to the wrong user (`999` vs `70`) but discovered this was not the case after engaging with delivery.



### Resolution

Resolved with a phone call:



Changes to get past read-only file system error:

create `ServiceAccount` `test-user` and `TODO`
at same level as security context add `serviceAccountName`: `test-user`
comment out `runAsUser: 999` and `runAsGroup: 999` in security context along with `allowPrivilegeEscalation: false`



### Relevant Docs Pages Used/Created



### Relevant Error / Logs

<!-- Please redact keys, tokens, and personal identifying information -->




<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 4506.md -->
