# New Slack message in support-indeed <!-- Ticket Title  Hint: include keywords to make it searchable -->
 
- Zendesk Link: [#3971](https://sourcegraph.zendesk.com/agent/tickets/3971)
- CSE: Jason Harris
- Customer: Indeed <!-- Redact if this contains personally identifying information -->

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->
 
## Technical Environment
- Version: `3.30.4`â€‹
- Deployment: kubernetes
- External Services: GITLAB
- Auth Providers: `saml`
 
 
## Links
<!-- Data for CSE manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/CSKMGUJ58/p1634756475053300
- GitHub Issue Link: https://github.com/sourcegraph/customer/issues/538
- Doc Update Link: n/a
 
## Summary
### Description of Customer Issue
When upgrading from `3.30.4` to `3.31.2`, the customer ran into an issue with permissions, blocking the `codeinsights-db` from starting.
 
### Troubleshooting Steps
- I went through a couple of issues ([364](https://github.com/sourcegraph/customer/issues/364), [377](https://github.com/sourcegraph/customer/issues/377)), which seemed related at the time, but found that they, in fact, only appeared so. 
- Asked for the output of two commands, because I suspected these would give me info on whether this had to do with an admissions controller being used with a mutatingWebHook
  - Asked for the output of the command `kubectl get pod <insert codeinsights-db-xxxxx> -o yaml`
  - Asked for the output of the command `kubectl get -A Mutatingwebhookconfigurations`
- Asked for more information on their `securityContext`
- Asked if they were running as root in `3.30.4` and had changed to running as non-root in `3.31.2`
  - Their answer was that they had always run with non-root.
  - Reason for my asking was that I thought they may have not migrated to non-privileged overlay when upgrading.
- Asked if they were using an external database that sourcegraph couldn't recognize. They answered no.
- Used a [diff comparison](https://sourcegraph.com/github.com/sourcegraph/deploy-sourcegraph/-/compare/v3.30.4...v3.31.2#diff-6baf617452458a7a30451069be86f9cb) in sourcegraph to compare `codeinsights-db.Deployment.yaml` files in `3.30.4` and `3.31.2` and found nothing different.
- Checked the `changelog` to see if there were any changes between `3.30.4` and `3.31.2` that would've caused them to suddenly lose permissions when upgrading. Found nothing.
 
### Resolution
I ultimately filed an issue, linked above, with delivery. I posted their original, non-functional, yaml file in the issue (pasted below):
 
```
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    description: Code Insights TimescaleDB instance.
  labels:
    app.kubernetes.io/component: codeinsights-db
    deploy: sourcegraph
    sourcegraph-resource-requires: no-cluster-admin
  name: codeinsights-db
  namespace: sourcegraph # Modified: Specify namespace for Sourcegraph
spec:
  minReadySeconds: 10
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: codeinsights-db
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        deploy: sourcegraph
        app: codeinsights-db
        group: backend
    spec:
      containers:
      - name: timescaledb
        image: index.docker.io/sourcegraph/codeinsights-db:3.31.2@sha256:912ba3900ab688b8ac23d8f7906e638160dda49c71490b8e3f69f04e81ffe8bf
        securityContext: # Modified: Do not run as root users
            # Required to prevent escalations to root.
            allowPrivilegeEscalation: false
            runAsUser: 70
            runAsGroup: 70
        env:
        - name: POSTGRES_PASSWORD # Accessible by Sourcegraph applications on the network only, so password auth is not used.
          value: password
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        - name: POSTGRESQL_CONF_DIR
          value: "/conf"
        terminationMessagePolicy: FallbackToLogsOnError
        ports:
        - containerPort: 5432
          name: timescaledb
        resources:
          limits:
            cpu: "4"
            memory: 2Gi
          requests:
            cpu: "4"
            memory: 2Gi
        volumeMounts:
        - mountPath: /data
          name: disk
        - mountPath: /conf
          name: timescaledb-conf
        # Modified: add volume mount to bypass read-only restriction on container filesystem
        - mountPath: /tmp
          name: tmpdir
        # Modified: add volume mount to bypass read-only restriction on container filesystem
        - mountPath: /var/run/postgresql
          name: tmpdir2
      # - env:
      #   - name: DATA_SOURCE_NAME
      #     value: postgres://sg:@localhost:5432/?sslmode=disable
      #   # Dax: Temporarily switch back to upstream postgres exporter
      #   # https://github.com/sourcegraph/sourcegraph/issues/18225
      #   image: wrouesnel/postgres_exporter:v0.7.0@sha256:785c919627c06f540d515aac88b7966f352403f73e931e70dc2cbf783146a98b
      #   terminationMessagePolicy: FallbackToLogsOnError
      #   name: pgsql-exporter
      #   resources:
      #     limits:
      #       cpu: 10m
      #       memory: 50Mi
      #     requests:
      #       cpu: 10m
      #       memory: 50Mi
      terminationGracePeriodSeconds: 120
      securityContext: # Modified: Do not run as root users
        # Required to prevent escalations to root.
        runAsUser: 70
      volumes:
      - name: disk
        persistentVolumeClaim:
          claimName: codeinsights-db
      - name: timescaledb-conf
        configMap:
          defaultMode: 0777
          name: codeinsights-db-conf
      # Modified: add volume mount to bypass read-only restriction on container filesystem
      - name: tmpdir
        emptyDir: {}
      # Modified: add volume mount to bypass read-only restriction on container filesystem
      - name: tmpdir2
        emptyDir: {}
```
        
Dave jumped in and tested this. He determined that they needed to use `initContainers` to to change the permissions on the mounted volumes BEFORE postgres needed to access them. Other wise, it won't be able to `chmod`.
 
The issue was solved with the following adjustments in the `yaml` file: 
 


 
```
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    description: Code Insights TimescaleDB instance.
  labels:
    app.kubernetes.io/component: codeinsights-db
    deploy: sourcegraph
    sourcegraph-resource-requires: no-cluster-admin
  name: codeinsights-db
  namespace: sourcegraph # Modified: Specify namespace for Sourcegraph
spec:
  minReadySeconds: 10
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: codeinsights-db
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        deploy: sourcegraph
        app: codeinsights-db
        group: backend
    spec:
      initContainers:
      - name: correct-data-dir-permissions
        image: index.docker.io/sourcegraph/alpine-3.12:3.31.2@sha256:775d9ae7ec5a8f32c81ce634251f022f1bf63acd006ef8c6de936350d5c4df2e
        command: ["sh", "-c", "if [ -d /data/pgdata ]; then chmod 750 /data/pgdata; fi"]
        volumeMounts:
        - mountPath: /data
          name: disk
        securityContext: # Modified: adjust the codeintel-db deployment to work with non-root user
          runAsUser: 70
          runAsGroup: 70
        resources:
          limits:
            cpu: "10m"
            memory: "50Mi"
          requests:
            cpu: "10m"
            memory: "50Mi"  
      containers:
      - name: timescaledb
        image: index.docker.io/sourcegraph/codeinsights-db:3.31.2@sha256:912ba3900ab688b8ac23d8f7906e638160dda49c71490b8e3f69f04e81ffe8bf
        securityContext: # Modified: Do not run as root users
            allowPrivilegeEscalation: false
            runAsUser: 70
            runAsGroup: 70
        env:
        - name: POSTGRES_PASSWORD # Accessible by Sourcegraph applications on the network only, so password auth is not used.
          value: password
        - name: PGDATA
          value: /data/pgdata
        - name: POSTGRESQL_CONF_DIR
          value: "/conf"
        terminationMessagePolicy: FallbackToLogsOnError
        ports:
        - containerPort: 5432
          name: timescaledb
        resources:
          limits:
            cpu: "4"
            memory: 2Gi
          requests:
            cpu: "4"
            memory: 2Gi
        volumeMounts:
        - mountPath: /data
          name: disk
        - mountPath: /conf
          name: timescaledb-conf
        - mountPath: /tmp
          name: tmpdir
        - mountPath: /var/run/postgresql
          name: tmpdir2          
      terminationGracePeriodSeconds: 120
      securityContext:
        runAsUser: 70
        runAsGroup: 70
        fsGroup: 70
        fsGroupChangePolicy: "OnRootMismatch"        
      volumes:
      - name: disk
        persistentVolumeClaim:
          claimName: codeinsights-db
      - name: timescaledb-conf
        configMap:
          defaultMode: 0777
          name: codeinsights-db-conf
      - name: tmpdir
        emptyDir: {}
      - name: tmpdir2
        emptyDir: {}

```
 
### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->
 
 
```
chmod: /var/run/postgresql: Operation not permitted

The files belonging to this database system will be owned by user "postgres".

This user must also own the server process.
```

```
/usr/local/bin/docker-entrypoint.sh: sourcing /docker-entrypoint-initdb.d/000_install_timescaledb.sh
/docker-entrypoint-initdb.d/000_install_timescaledb.sh: line 39: /conf/postgresql.conf: Read-only file system
```

<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 3971.md -->
