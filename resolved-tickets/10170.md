# Dirty database on upgrade to v3.42.1 - Helm <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#10170](https://sourcegraph.zendesk.com/agent/tickets/10170)
- Application engineer: Gabe Torres
- Customer: Telus <!-- Redact if this contains personally identifying information -->
- Date: August 2, 2022

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: ​3.41.0
- Deployment: Helm
- External Services:
- Auth Providers:


## Links
<!-- Data for application engineer manual entry -->
- Slack Links:
- GitHub Issue Link:
- Doc Update Link:

## Summary
### Customer Question
I just tried upgrading our sourcegraph instance to 3.42.1, I'm getting this error:
```
executors-janitor: failed to connect to frontend database: dirty database: schema \"frontend\" marked the following migrations as failed: 1655763641\nThe target schema is marked as dirty and no other migration operation is seen running on this schema. The last migration operation over this schema has failed (or, at least, the migrator instance issuing that migration has died). Please contact support@sourcegraph.com for further assistance.\n
```


### Application Engineer Answer
We have a guide to run the migrations that failed manually. https://docs.sourcegraph.com/admin/how-to/dirty_database#steps-to-resolve 
For step 1, the logs say that this migration failed 1655763641.
For step 2, you will have to connect to pgsql and run this migration. https://github.com/sourcegraph/sourcegraph/blob/main/migrations/frontend/1655763641_faster_workspace_batch_spec_lookup/up.sql
For step 3, you can use the Migrator Helm Chart. Once the migration is applied, add a migration log entry.  
https://github.com/sourcegraph/deploy-sourcegraph-helm/tree/main/charts/sourcegraph-migrator#sourcegraph-migrator-helm-chart  
https://github.com/sourcegraph/deploy-sourcegraph-helm/tree/main/charts/sourcegraph-migrator#add-a-migration-log-entry

### Relevant Docs Pages Used/Created
https://docs.sourcegraph.com/admin/how-to/dirty_database

<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 10170.md -->
