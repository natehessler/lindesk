
# Batch changes / repo removal regression - renamed repo note removed causes batch changes to fail <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#5724](https://sourcegraph.zendesk.com/agent/tickets/5724)
- Application engineer: Giselle Northy
- Customer: Reddit <!-- Redact if this contains personally identifying information -->
- Date: Jan 21

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.34.2‚Äã
- Deployment: kubernetes
- External Services: GITHUB
- Auth Providers: builtin,github


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/C02BJ8T258D/p1642789851051700
- GitHub Issue Link: https://github.com/sourcegraph/zoekt/pull/244
- Doc Update Link:

## Summary
### Description of Customer Issue

Hi! Running into an issue where running src batch preview is failing due to a renamed repository.
```‚ùå Error:
resolving repositories: resolving "<QUERY REDACTED>": GraphQL errors: 1 error occurred:
* {
"message": "repository does not exist: <REPO URL REDACTED>",
"path": [
"search",
"results",
"results",
162,
"repository",
"defaultBranch"
]
}
```
üí° The troubleshooting documentation can help to narrow down the cause of the errors:
https://docs.sourcegraph.com/batch_changes/references/troubleshooting```
In this case, &lt;REPO URL REDACTED&gt; is the old repository from before the rename. Attempting to use -repo to exclude this old repository doesn't help. Any suggestions on how to proceed?

### Troubleshooting Steps

### Resolution

I did some research and found that this has been recently reported by some other folks. We recently had a regression and an issue has been filed, but not released quite yet.
 
Essentially when a repository is renamed on the code host, Sourcegraph is not successfully clearing all its data from that repository. It will see the renamed repository as a ‚Äúnew‚Äù repo, and then try to maintain both the old copy and the new copy. Then, when batch changes are run, it will give ‚Äúrepo not found‚Äù errors on the old version of the repo.
 
We have a work around in the meantime, which will be to exclude the old name of the repo so it is no longer acting as a redirect from the new -> old repo which makes it unclone-able.
 
Please navigate to Site Admin -> Manage Code Hosts -> (Select your code host)
 
In the configuration JSON file, please add the following repo exclusion:

```json
"exclude": [
{
"name": "put/the/old/repo/name/here"
}
],
```
 
After a few minutes, Sourcegraph should remove the repo from your instance, and prevent it from being rediscovered which should resolve the issue.
 
You can confirm this deletion is done by navigating to:
Site Admin -> Repository Status and searching for the repository by name.
 
If the repository does not appear, then it has been completely removed from your instance, and your batch change should resolve without error.




### Relevant Docs Pages Used/Created

### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->


<!--¬†Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets¬†as a .md file -->
<!-- Name the file 5724.md -->
