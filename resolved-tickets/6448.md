# Code Insights db server refused TLS connection <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#6448](https://sourcegraph.zendesk.com/agent/tickets/6448)
- Application engineer: Quinlan Sparks
- Customer: Neo Financial <!-- Redact if this contains personally identifying information -->
- Date: Feb 23

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.37
- Deployment: Docker-Compose
- External Services: AWS
- Auth Providers: 


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: 
https://sourcegraph.slack.com/archives/C02QAEHR9EG/p1645646441023619
https://sourcegraph.slack.com/archives/C02QAEHR9EG/p1645647790523349
- GitHub Issue Link: https://github.com/sourcegraph/customer/issues/733
- Doc Update Link: https://github.com/sourcegraph/sourcegraph/pull/31948

## Summary
### Description of Customer Issue
At first the customer was running into the expected issues with attempting to upgrade directly from 3.35 to 3.37. It was a new instance, so they dumped everything and started fresh with a clean installation of 3.37. That resolved the migration problem, but surfaced a refused TLS connection to the Code Insights database - which was odd, considering the customer and I would both have expected the external frontend and Code Intelligence databases to have trouble connecting if there was going to be a problem, not the internal Code Insights db.

### Troubleshooting Steps
I first noticed that the `migrator` container in their `docker-compose.yaml` file had not been updated to point at the external databases, as that instruction was missing from the documentation. This did not turn out to be the root cause, but likely would have caused a secondary error if it had not been caught during my discussion with a member of the delivery team.

Delivery was able to reproduce the behavior by setting up a local pgsql databse that enforces SSL, then setting the `PGSSLMODE` environment varriable to `require` in the `migrator` and frontend containers.

### Resolution
Setting `PGSSLMODE` to `require` for their external databases also tried to enforce SSL on their internal Code Insights db, which Delivery pointed out may be fixed by happenstance in the next release when Timescale is deprecated. In the meantime, the customer was able to work around this by using the long form of the database connections in their configuration.

After ensuring that the `migrator` container was pointing to the correct external databases, they updated `sourcegraph-frontend-0` and `sourcegraph-frontend-internal` to remove the `CODEINSIGHTS_PGDATASOURCE` environment variable and replace it with the following in both frontend containers:

```yaml
- CODEINSIGHTS_PGHOST=codeinsights-db
- CODEINSIGHTS_PGPORT=5432
- CODEINSIGHTS_PGUSER=postgres
- CODEINSIGHTS_PGPASSWORD=password
- CODEINSIGHTS_PGDATABASE=postgres
- CODEINSIGHTS_PGSSLMODE=disable
```

### Relevant Docs Pages Used/Created
https://docs.sourcegraph.com/admin/external_services/postgres#docker-compose

### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->
```md
failed to initialize insights: Failed to connect to codeinsights database: DB not available: server refused TLS connection
```


<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 6448.md -->
