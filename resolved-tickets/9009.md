
# Batch change error when executing changeset specs <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#9009](https://sourcegraph.zendesk.com/agent/tickets/9009)
- Application engineer: Michael Bali
- Customer: Mercari <!-- Redact if this contains personally identifying information -->
- Date: June 14, 2022

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.37.0​
- Deployment: kubernetes
- External Services: GITHUB
- Auth Providers: openidconnect


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/C018U1ZRFQC/p1655274148375819
- GitHub Issue Link: N/A
- Doc Update Link: N/A

## Summary

### Description of Customer Issue
Executing the changes locally works fine, the issue appears when the changeset specs are being submitted.
After approximately a minute, the request ultimately fails

### Troubleshooting Steps
- Are you trying to make these changes across hundreds of repositories?
- Is src connected to the right sourcegraph URL?
- In order to find out whether this problem is related to the size or scope of a batch change or with what it’s trying to achieve, try reducing the scope of your batch change.
- You can do so by changing the `on.repositoriesMatchingQuery` to yield less results or by using a concrete list of repositories with `on.repository`. Trying this on one or 2 repos. Something like the below:
```
on:
  - repository: github.com/my-org/my-repo1
  - repository: github.com/my-org/my-repo2
  
```

- Also, do you have [configured credentials](https://docs.sourcegraph.com/batch_changes/how-tos/configuring_credentials) with all of the required scopes and from an account with write access to the changeset’s repository on the code host.

### Resolution
The scope of the change was also very large, fixing that allowed even the large repo to be processed correctly.

### Relevant Docs Pages Used/Created

### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->
```
❌ Error:
   error: 502 Bad Gateway


   <html><head>
   <meta http-equiv="content-type" content="text/html;charset=utf-8">
   <title>502 Server Error</title>
   </head>
   <body text=#000000 bgcolor=#ffffff>
   <h1>Error: Server Error</h1>
   <h2>The server encountered a temporary error and could not complete your request.<p>Please try again in 30 seconds.</h2>
   <h2></h2>
   </body></html>


```


```
{"SeverityText":"ERROR","Timestamp":1655271409153832245,"InstrumentationScope":"database.batch.database.batch.Flush","Caller":"batch/batch.go:221","Function":"github.com/sourcegraph/sourcegraph/internal/database/batch.(*Inserter).Flush","Body":"operation.error","Resource":{"service.name":"frontend","service.version":"3.40.0","service.instance.id":"sourcegraph-frontend-7b49b45558-njpk8"},"Attributes":{"batchSize":14,"payloadSize":24,"tableName":"changeset_specs","columnNames":"rand_id,spec,batch_spec_id,repo_id,user_id,diff_stat_added,diff_stat_changed,diff_stat_deleted,created_at,updated_at,fork_namespace,external_id,head_ref,title","numColumns":14,"maxBatchSize":32760,"count":1,"elapsed":41.199225097,"error":"timeout: context canceled"}}
{"SeverityText":"ERROR","Timestamp":1655271409154271939,"InstrumentationScope":"enterprise.batches.dbstore.CreateChangesetSpec","Caller":"store/changeset_specs.go:128","Function":"github.com/sourcegraph/sourcegraph/enterprise/internal/batches/store.(*Store).CreateChangesetSpec","Body":"operation.error","Resource":{"service.name":"frontend","service.version":"3.40.0","service.instance.id":"sourcegraph-frontend-7b49b45558-njpk8"},"Attributes":{"Count":1,"count":1,"elapsed":48.097838065,"error":"inserter.Flush: timeout: context canceled"}}
{"SeverityText":"ERROR","Timestamp":1655271409154348637,"InstrumentationScope":"enterprise.batches.service.CreateChangesetSpec","Caller":"service/service.go:668","Function":"github.com/sourcegraph/sourcegraph/enterprise/internal/batches/service.(*Service).CreateChangesetSpec","Body":"operation.error","Resource":{"service.name":"frontend","service.version":"3.40.0","service.instance.id":"sourcegraph-frontend-7b49b45558-njpk8"},"Attributes":{"count":1,"elapsed":54.880328752,"error":"inserter.Flush: timeout: context canceled"}}
```


<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 9009.md -->
