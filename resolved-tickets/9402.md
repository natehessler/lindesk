​
# Support Help with Caddy Component of Sourcegraph <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#9402](https://sourcegraph.zendesk.com/agent/tickets/9402)
- Application engineer: Alex Jean-Baptiste
- Customer: GOV.UK <!-- Redact if this contains personally identifying information -->
- Date: June 29, 2022

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.37.0​
- Deployment: kubernetes
- External Services: TBD
- Auth Providers: builtin 
​
​
## Links
<!-- Data for application engineer manual entry -->
- Slack Links: N/A (Email Thread)
- GitHub Issue Link: https://github.com/sourcegraph/customer/issues/1115
- Doc Update Link: N/A

## Summary
### Customer Question

​
​I’ve got an install of Sourcegraph using the docker-compose.yml.  I am using LetsEncrypt certificates, but I’m using the custom certificate installation as our production instance won’t use LetsEncrypt.

The installation and the certificates have been validated and the installation is working on the local system.

If I add:

127.0.0.1 sourcegraph.services-dev.ios-dev-shared.dwpcloud.uk

To /etc/hosts and perform:

wget https://sourcegraph.services-dev.ios-dev-shared.dwpcloud.uk

I get the index.html page back.

The issue I need help with is when presenting this out via an ELB on AWS.  I’m getting a 502 error back when trying to present this out because the host header isn’t what Caddy expects.  This is also showing on the Health Check for the target groups as they are failing when trying to use https for health checks as they are not being requested via sourcegraph.services-dev.ios-dev-shared.dwpcloud.uk.

My current Caddyfile is:
# Serves Sourcegraph over HTTPS, using a custom SSL certificate/key pair
# that's bind mounted from the host to /sourcegraph.pem and /sourcegraph.key.
#
# Caddyfile documentation: https://caddyserver.com/docs/caddyfile

{\$SRC_SITE_ADDRESS}

# Redirects all HTTP traffic to HTTPS (using custom SSL certificates disables the automatic HTTPS feature of Caddy, see https://caddyserver.com/docs/automatic-https)
@http {
protocol http
}
redir @http https://{host}{uri}

tls /sourcegraph.pem /sourcegraph.key

# Add the reverse proxies IPs (or IP CIDR ranges) to the trusted_proxies list.
# More information in https://caddyserver.com/docs/caddyfile/directives/reverse_proxy
reverse_proxy {
to {\$SRC_FRONTEND_ADDRESSES}
trusted_proxies 0.0.0.0/0
}

This works when requesting Sourcegraph via sourcegraph.services-dev.ios-dev-shared.dwpcloud.uk, but not via the LB address of internal-shared-dev-sourcegraph-alb-1819311719.eu-west-2.elb.amazonaws.com or via IP address of the box.
I essentially need Caddy to route all traffic to the HTTPS site and serve out the certificate and website, regardless of the HTTP host header requested, I understand I’ll get a certificate error should the certificate not match.  I thought I could potentially do this using default_sni, but I’ve been unable to get this working.
​
​
### Application Engineer Answer
​
​Configure Caddy to route all HTTPS traffic to the Sourcegraph Frontend.
Use the https.custom-cert.Caddyfile
Remove {$SRC_SITE_ADDRESS} from the Caddyfile

3.    Replace with :443 (listen to all HTTPS traffic).

Below is an example of what your Caddyfile will now look like with that configuration.


# Serves Sourcegraph over HTTPS, using a custom SSL certificate/key pair
# that's bind mounted from the host to /sourcegraph.pem and /sourcegraph.key.#
# Caddyfile documentation: https://caddyserver.com/docs/caddyfile

:443
# Redirects all HTTP traffic to HTTPS (using custom SSL certificates disables the automatic HTTPS feature of Caddy, see https://caddyserver.com/docs/automatic-https)
@http {
       protocol http
}
redir @http https://{host}{uri}

tls /sourcegraph.pem /sourcegraph.key

# Add the reverse proxies IPs (or IP CIDR ranges) to the trusted_proxies list.
# More information in https://caddyserver.com/docs/caddyfile/directives/reverse_proxyreverse_proxy {
       to {$SRC_FRONTEND_ADDRESSES}        trusted_proxies 0.0.0.0/0
}

We reproduced the issue in the following way to come to this solution for you.

- Created an Application Load Balancer where the default routing rules forwarded to the target group of an EC2 instance listening on port 443

- Created a self-signed certificate using mkcert and placed them within the path of a Docker Compose installation of Sourcegraph. Modified the docker-compose.yaml file to mount the certificate and key into the caddy container. The certificate was issued to sourcegraph.<domain>.<tld> which does NOT match the internal name of the EC2 instance, but it does match the external name of the ELB. The name is not important as the ELB will ignore name mismatch errors. What is important, however, is that a certificate is installed and used to encrypt traffic between the EC2 instance and the Elastic Load Balancer.

Please make sure you have your AWS Security Groups configured correctly to allow the following.

1) HTTPS traffic to the ELB from the Internet/ your Corporate Network 
2) HTTPS Traffic between the ELB and the EC2 instance
​

### Relevant Docs Pages Used/Created

<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 9402.md -->
