# Lyft - Slack - 3.29.0 to 3.30.4 problems 



- **Zendesk Link:** [#3591](https://sourcegraph.zendesk.com/agent/tickets/3591)

- **CSE:** Gabe Torres

- **Customer:** Lyft, Inc. <!-- Redact if this contains personally identifying information -->


<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->

<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->



## Technical Environment

- **Version:** 3.30.4​

- **Deployment:** kubernetes

- **External Services:** GITHUB

- **Auth Providers:** saml





## Links
<!-- Data for CSE manual entry -->
- **Slack Links:** https://sourcegraph.slack.com/archives/C0174NVAREV/p1632868259016100

- **GitHub Issue Link:** NA

- **Doc Update Link:** NA



## Summary
### Description of Customer Issue: 
After upgrading from 3.29.0 to 3.30.4 the customer reported that the pgsql container was in a crashloopbackoff. 

### Troubleshooting Steps: 
The error message (in Relevant Error) from the events on the container gave us a good clue that Postgres was refusing new connections because the connection limit was reached.
`kubectl get event --namespace abc-namespace --field-selector involvedObject.name=my-pod-zl6m6`
This clue was reinforced after the admin scaled down the replicas of frontend pods from 6 to 2, and the instance stabilized.
Each replica of frontend, gitserver, repo-updater, and precise-code-intel-worker opens a pool of connections to Postgres, this number of connections is 30 by default. It's possible that after upgrading and redeploying the instance, this overloaded the max_connections setting for Postgres. 
The customer also noted the connection to GitHub was not working. Adding in the GitHub token again fixed this error.

https://github.com/sourcegraph/deploy-sourcegraph/blob/master/base/pgsql/pgsql.ConfigMap.yaml#L77 
https://docs.sourcegraph.com/admin/config/postgres-conf#resource-dependent-configuration


### Resolution:
Increasing the max_connections to 300 stabilized their instance.

### Relevant Error / Logs:  

<!-- Please redact keys, tokens, and personal identifying information -->
```
Normal   Pulled                  13m                     kubelet                  Container image "sourcegraph/postgres-12.6:3.30.4" already present on machine
Normal   Created                 13m (x2 over 14m)       kubelet                  Created container pgsql
Warning  Unhealthy               12m (x5 over 13m)       kubelet                  Liveness probe failed: psql: error: FATAL:  sorry, too many clients already
Warning  Unhealthy               8m39s (x20 over 13m)    kubelet                  Readiness probe failed: psql: error: FATAL:  sorry, too many clients already
Warning  BackOff                 4m14s (x10 over 5m56s)  kubelet                  Back-off restarting failed container
```




<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 3591.md -->
