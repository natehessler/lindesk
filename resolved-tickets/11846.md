
# Failed upgrade sourcegraph <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#11846](https://sourcegraph.zendesk.com/agent/tickets/11846)
- Application engineer: Michael Bali
- Customer: Booking.com <!-- Redact if this contains personally identifying information -->
- Date: October 24, 2022

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.37.0​
- Deployment: kubernetes
- External Services: GITLAB
- Auth Providers: gitlab


## Links
<!-- Data for application engineer manual entry -->
- Slack Links:
- GitHub Issue Link:
- Doc Update Link:

## Summary
### Description of Customer Issue
I got an error when upgrading sourcegraph:
`failed to run migration for schema "frontend": dirty database: schema "frontend" marked the following migrations as failed: 1663871069`
I followed the steps https://docs.sourcegraph.com/admin/how-to/dirty_database and there is some violation on running that SQL code.
```
sg=# BEGIN;
BEGIN
sg=# UPDATE changeset_specs
sg-# SET published = NULL
sg-# WHERE published = 'null';
UPDATE 0
sg=# ALTER TABLE changeset_specs
sg-# DROP CONSTRAINT IF EXISTS changeset_specs_published_valid_values,
sg-# ADD CONSTRAINT changeset_specs_published_valid_values CHECK (published = 'true' OR published = 'false' OR
sg(# published = '"draft"' OR published IS NULL);
NOTICE: constraint "changeset_specs_published_valid_values" of relation "changeset_specs" does not exist, skipping
ERROR: check constraint "changeset_specs_published_valid_values" is violated by some row
sg=# COMMIT;
```


### Troubleshooting Steps
I noticed this behavior also in my test instance, while performing an upgrade.
### Resolution

 The issue is, the constraint is checking for `published = '"draft"'` but there are some columns with the value `'draft'`.
The following query should give the results
```
SELECT count(*) FROM  changeset_specs WHERE published = 'draft';
```


While the below query would return 0
```
SELECT count(*) FROM  changeset_specs WHERE published = '"draft"';
```


The quote (`"`) is because we treat that field as a boolean and a string. So to get around this strange behavior, we marshal the value to JSON (why the string value as double quote).
We’re going to [modify](https://github.com/sourcegraph/sourcegraph/pull/43390) the migration to handle this case automatically.

In the meantime, The temporary mitigation for this is to change the rows with draft to "draft" reapply the migration and record the migration log entry.

```
ALTER TABLE changeset_specs
DROP CONSTRAINT IF EXISTS changeset_specs_published_valid_values;

update changeset_specs set published = '"draft"' where published = 'draft';

```

### Relevant Docs Pages Used/Created

### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->

```
ERROR: check constraint "changeset_specs_published_valid_values" is violated by some row
```


<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 11846.md -->
