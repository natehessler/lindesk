
# new instance deployed without a formal migration; want to "migrate" users; also github auth redirect <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#7496](https://sourcegraph.zendesk.com/agent/tickets/7496)
- Application engineer: Kelvin Lee
- Customer: Snowflake, Inc. <!-- Redact if this contains personally identifying information -->
- Date: Apr 6

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.34.1​
- Deployment: docker-compose
- External Services: GITHUB
- Auth Providers: builtin,github


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: Many... [1st](https://sourcegraph.slack.com/archives/C021MU16S1F/p1649268797261969), [2nd](https://sourcegraph.slack.com/archives/C021MU16S1F/p1650651019083639), [3rd](https://sourcegraph.slack.com/archives/C021MU16S1F/p1651093672473329), [4th](https://sourcegraph.slack.com/archives/C021MU16S1F/p1651519754964289), [5th](https://sourcegraph.slack.com/archives/C021MU16S1F/p1651620301095239).
- GitHub Issue Link: [RFH](https://github.com/sourcegraph/customer/issues/902)
- Doc Update Link: 

## Summary
### Customer Question

⚠️ The title of the ticket does not greatly represent the contents here, unfortunately.

Many questions 😅 . Some of the questions, I had brought to the RFH.

1. Some sort of issues with authing in?

   **Answers/Notes**:

   I'm not sure how this was solved, but some useful tools/troubleshooting/diagnostics include:
   - https://docs.sourcegraph.com/admin/config/site_config#email-address Getting this configured seems like a good precautionary
   - https://docs.sourcegraph.com/admin/config/site_config#editing-your-site-configuration-if-you-cannot-access-the-web-ui Specifies how to change the sigte-config if you are simultaneously unable to access the UI
   - https://docs.sourcegraph.com/admin/auth#github
   - https://developer.github.com/apps/building-oauth-apps/creating-an-oauth-app/
   - postgres query that seems useful:

   > Since we’re not sure if there is a user or user email, lets confirm what’s in the user and user email tables. Can you query the PGSQL database and we can check?
   > The query  should be:
   > 
   > `SELECT * FROM "public"."user_emails";`
   > 
   > and for good measure let’s check the user table:
   > 
   > `SELECT * FROM "public"."users" ORDER BY "id";`
   
1. Generically, how do migrations go, if we want to preserve data?

   **Answer**:

   The high-level view of a migration is: (1) create the data dumps (2) and then re-seed the new instance with the data-dumps. This, of course, can come with a host of different problems e.g. [dirty database shenanigans](https://docs.sourcegraph.com/admin/how-to/dirty_database_pre_3_37).

   Internally, one such problem is that: Our documentation does not fully cover, in an easy, highly accessible way, migrations of all sorts (i.e. from compose to kubernetes, or container to kubernetes, or kubernetes to compose, etc.). It can be pieced together, but it's not crystal clear. An example of pieceing it together is in the answer below, for "What is `sourcegraph/server`?"

   
1. What is `sourcegraph/server`?

   **Answer**:
   
   `sourcegraph/server` is the name of the [Docker image](https://hub.docker.com/r/sourcegraph/server) that uhhh, I think, is used for docker-container deployments. It should be non-applicable to, say, a docker-compose or a Kubernetes deplyoment.

   The customer had the question about `sourcegraph/server` because they were referencing the [wrong documentation](https://docs.sourcegraph.com/admin/deploy/docker-compose/migrate#migration-guide) for their deployment. It is pertinent that, when doing a migration, that customers reference the correct documentation + is mindful of which step of the migration they're on (Either creating the data dumps, or seeding the data dumps).

   Example: For this customer, who wanted to go from docker-compose to kubernetes, the first step would be [here](https://docs.sourcegraph.com/admin/deploy/docker-compose#back-up-sourcegraph-databases), for generating the dumps from a docker-compose, and then the customer would stop before getting to the "Restoring sourcegraph databases into an existing environment" section. The customer would then, instead, restore using the restore process for a _Kubernetes_ deployment, [here](https://docs.sourcegraph.com/admin/deploy/kubernetes/operations#restoring-sourcegraph-databases-into-a-new-environment).


1. > How can i tell if the migration worked?

   **Answer**: 
   
   We don't have any lightweight diagnostics, unfortunately. The best way just seems to be to poke around the deployment and check that things we expect to have been migrated are there, or to check logs for errors. [This table](https://docs.sourcegraph.com/admin/deploy/migrate-backup#internal-database-postgresql) describes what we expect to have been migrated over in a data-preserving migration.

1. Error log:

   ```
   psql: error: connection to server on socket "/run/postgresql/.s.PGSQL.5432" failed: No such file or directory
	Is the server running locally and accepting connections on that socket?
   ```

   **Theory**:

   This was unique to the customer's deployment. They had a whacky, separate, custom container deployed within the cluster that they called "`debug`", and were using it as a sort of... command-middle-man to their other containers. Stackoverflow seemed to have serviced them well here.


1. Error log:

   ```
   t=2022-05-02T18:39:23+0000 lvl=eror msg="Syncing repo state" error ="fetching gitserver status: ERROR: column gr.last_external_service does not exist (SQLSTATE 42703)"
   ```

   **Answer**:
   
   This was due to versioning, I believe. The customer _may_ have downgraded an instance without following the [rollback docs](https://docs.sourcegraph.com/admin/how-to/rollback_database), which is generally considered risky. I believe the `column XXX does not exist` error is the most telling (I could've sworn that I was able to find this error message in our resolved-tickets, but I cannot right now).

   Make sure that, when conducting a migration, that the deployment that is being migrated away from shares the version as the deployment that is being migrated to. I.e. one must migrate from a version 3.34 deployment to another version 3.34 deployment. Explained to the customer...:

   > ...Migrating version A data into a version B database is not guaranteed to work neither; sometimes more columns are added, schemas change, that sort of stuff

1. > does sourcegraph auto-create the 'sourcegraph' db and sourcegraph-codeinsights db?

   **Answer**:

   > Yes, these databases are automatically initiated when not present.

   I could've sworn this is documented somewhere, but can't find at this time of writing.

1. > Is there going to be an issue if the role is named differently i.e. that sfcadmin != sg ? They seem to want to use their own role and identifier here. As long as they configure their $PGUSER=sfcadmin (as instructed in our docs here, I assume this should be okay? Will there be any issues with having had the dumps been generated by a different user, and then imported as this new sfcadmin? I assume it's owner-agnostic once the dump is generated?

   **Answer, from RFH:**

   > There should be no issue using a differently-named role as long as it is consistent across all of the environment variables and configuration contained in the k8s manifests.

   I believe these enviroment variables are [here](https://docs.sourcegraph.com/admin/external_services/postgres#:~:text=PGHOST%3Dpsql%0APGUSER%3Dsourcegraph%0APGPASSWORD%3Dsecret%0APGDATABASE%3Dsourcegraph)

1. Error log:

   ```
   psql:/tmp/sourcegraph_db.out:1769: ERROR:  role "sg" does not exist
   ```

   **Answer/Theory, from RFH**:

   > This error message hints that the Docker-Compose setup they're migrating from was using "sg" and not "sfcadmin". They may be able to do a find-and-replace on the SQL dump to change sg->sfcadmin, but that's definitely adding more complexity to the problem.


1. Error log:

   ```
   psql:/tmp/sourcegraph_db.out:1766: ERROR:  relation "external_service_repos" already exists
   psql:/tmp/sourcegraph_db.out:1744: ERROR:  relation "executor_heartbeats_id_seq" already exists
   psql:/tmp/sourcegraph_db.out:1780: ERROR:  relation "external_service_sync_jobs_id_seq" already exists
   psql:/tmp/sourcegraph_db.out:1803: ERROR:  relation "external_service_sync_jobs" already exists
   psql:/tmp/sourcegraph_db.out:1830: ERROR:  relation "external_services" already exists
   psql:/tmp/sourcegraph_db.out:1852: ERROR:  relation "external_service_sync_jobs_with_next_sync_at" already exists
   ```

   **Answer/Theory, from RFH**:

   > The next thing that gives me pause are these error messages. This indicates the customer is attempting to load a database dump into a database that has already been initialized. This is either from a previous failed attempt OR the migrator started and created the initial schema.
   >
   > If they are trying to load in data into a new database, they may need to delete the database with DROP DATABASE <database_name> and recreate it with CREATE database. This process is outlined here: https://docs.sourcegraph.com/admin/external_services/postgres#using-restricted-permissions-for-pgsql-frontend-db

   This drop-then-recreate strategy is also recorded [here](https://handbook.sourcegraph.com/departments/support/process/enablement/k8-migration/), in a handbook guide. Thank you to Michael Bali for the [suggestion](https://sourcegraph.slack.com/archives/C01JR51JR5J/p1651132589898199?thread_ts=1651108986.800519&cid=C01JR51JR5J).

1. Customer sees the migration error...:

   ```
   ERROR: Failed to migrate the DB. Please contact support@sourcegraph.com for further assistance: Dirty database version 1528395877. Fix and force version.
   ```

   ... But cannot find the migration where the docs specify.

   **Answer**: Docs updated to make sure that one searches https://github.com/sourcegraph/sourcegraph/tree/main/migrations/frontend _to the correct version_ i.e. replacing `/main` with, say, `3.34`.


### Application Engineer Answer
Answers are threaded into the questions, above.

### Relevant Docs Pages Used/Created

https://developer.github.com/apps/building-oauth-apps/creating-an-oauth-app/
https://docs.sourcegraph.com/admin/auth#github
https://docs.sourcegraph.com/admin/config/site_config#editing-your-site-configuration-if-you-cannot-access-the-web-ui
https://docs.sourcegraph.com/admin/config/site_config#email-address

https://docs.sourcegraph.com/admin/deploy/docker-compose#back-up-sourcegraph-databases
https://docs.sourcegraph.com/admin/deploy/docker-compose/migrate#migration-guide
https://docs.sourcegraph.com/admin/deploy/kubernetes/operations#restoring-sourcegraph-databases-into-a-new-environment
https://docs.sourcegraph.com/admin/deploy/migrate-backup#internal-database-postgresql
https://docs.sourcegraph.com/admin/external_services/postgres#:~:text=PGHOST%3Dpsql%0APGUSER%3Dsourcegraph%0APGPASSWORD%3Dsecret%0APGDATABASE%3Dsourcegraph
https://docs.sourcegraph.com/admin/external_services/postgres#using-restricted-permissions-for-pgsql-frontend-db
https://docs.sourcegraph.com/admin/how-to/dirty_database_pre_3_37
https://docs.sourcegraph.com/admin/how-to/rollback_database
https://github.com/sourcegraph/sourcegraph/tree/main/migrations/frontend
https://hub.docker.com/r/sourcegraph/server

<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 7496.md -->
