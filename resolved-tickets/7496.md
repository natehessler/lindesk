
# new instance deployed without a formal migration; want to "migrate" users; also github auth redirect <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#7496](https://sourcegraph.zendesk.com/agent/tickets/7496)
- Application engineer: Kelvin Lee
- Customer: Snowflake, Inc. <!-- Redact if this contains personally identifying information -->
- Date: Apr 6

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.34.1â€‹
- Deployment: docker-compose
- External Services: GITHUB
- Auth Providers: builtin,github


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: Many... [1st](https://sourcegraph.slack.com/archives/C021MU16S1F/p1649268797261969), [2nd](https://sourcegraph.slack.com/archives/C021MU16S1F/p1650651019083639), [3rd](https://sourcegraph.slack.com/archives/C021MU16S1F/p1651093672473329), [4th](https://sourcegraph.slack.com/archives/C021MU16S1F/p1651519754964289), [5th](https://sourcegraph.slack.com/archives/C021MU16S1F/p1651620301095239).
- GitHub Issue Link: [RFH](https://github.com/sourcegraph/customer/issues/902)
- Doc Update Link: 

## Summary
### Customer Question
Many ðŸ˜… Some of the questions, I bring to to RFH.

1. Generically, how do migrations go, if we want to preserve data?

   **Answer**:

   The high-level view of a migration is: (1) create the data dumps (2) and then re-seed the new instance with the data-dumps. This, of course, can come with a host of different problems e.g. [dirty database shenanigans](https://docs.sourcegraph.com/admin/how-to/dirty_database_pre_3_37).

   Internally, one such problem is that: Our documentation does not fully cover, in an easy, highly accessible way, migrations of all sorts (i.e. from compose to kubernetes, or container to kubernetes, or kubernetes to compose, etc.). It can be pieced together, but it's not crystal clear.

   

1. > Is there going to be an issue if the role is named differently i.e. that sfcadmin != sg ? They seem to want to use their own role and identifier here. As long as they configure their $PGUSER=sfcadmin (as instructed in our docs here, I assume this should be okay? Will there be any issues with having had the dumps been generated by a different user, and then imported as this new sfcadmin? I assume it's owner-agnostic once the dump is generated?

   **Answer, from RFH:**

   > There should be no issue using a differently-named role as long as it is consistent across all of the environment variables and configuration contained in the k8s manifests.

1. Customer sees the migration error...:

   ```
   ERROR: Failed to migrate the DB. Please contact support@sourcegraph.com for further assistance: Dirty database version 1528395877. Fix and force version.
   ```

   ... But cannot find the migration where the docs specify.

   **Answer**: Docs updated to make sure that one searches https://github.com/sourcegraph/sourcegraph/tree/main/migrations/frontend _to the correct version_ i.e. replacing `/main` with, say, `3.34`.

1. Error log:

   ```
   psql:/tmp/sourcegraph_db.out:1769: ERROR:  role "sg" does not exist
   ```

   **Answer/Theory, from RFH**:

   > This error message hints that the Docker-Compose setup they're migrating from was using "sg" and not "sfcadmin". They may be able to do a find-and-replace on the SQL dump to change sg->sfcadmin, but that's definitely adding more complexity to the problem.


1. Error log:

   ```
   psql:/tmp/sourcegraph_db.out:1766: ERROR:  relation "external_service_repos" already exists

   ```

   **Answer/Theory, from RFH**:

   > The next thing that gives me pause are these error messages. This indicates the customer is attempting to load a database dump into a database that has already been initialized. This is either from a previous failed attempt OR the migrator started and created the initial schema.
   >
   > If they are trying to load in data into a new database, they may need to delete the database with DROP DATABASE <database_name> and recreate it with CREATE database. This process is outlined here: https://docs.sourcegraph.com/admin/external_services/postgres#using-restricted-permissions-for-pgsql-frontend-db

   This drop-then-recreate strategy is also recorded [here](https://handbook.sourcegraph.com/departments/support/process/enablement/k8-migration/), in a handbook guide. Thank you to Michael Bali for the [suggestion](https://sourcegraph.slack.com/archives/C01JR51JR5J/p1651132589898199?thread_ts=1651108986.800519&cid=C01JR51JR5J).


### Application Engineer Answer

### Relevant Docs Pages Used/Created

<!--Â Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-ticketsÂ as a .md file -->
<!-- Name the file 7496.md -->
