
# Stale permission alerts firing in Grafana <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#7877](https://sourcegraph.zendesk.com/agent/tickets/7877)
- Application engineer: Michael Bali
- Customer: Citrix <!-- Redact if this contains personally identifying information -->
- Date: April 26, 2022

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.39.1​
- Deployment: docker-compose
- External Services: BITBUCKETSERVER
- Auth Providers: saml


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/CT9P97S6L/p1651038578740999
- GitHub Issue Link: https://github.com/sourcegraph/customer/issues/978
- Doc Update Link: N/A

## Summary
### Description of Customer Issue
The following alerts were firing in Grafana.
- repo-updater: `259200s+ time gap between least and most up to date permissions for 5m0s`
- repo-updater: `100+ number of entities with stale permissions for 5m0s`
 
### Troubleshooting Steps
- Tried increasing the API rate limit, but didn't fix it 
- Tried configuring the `repoListUpdateInterval` to 5. Found out this resolved the issue for a customer.
- checked the scopes granted on the affected user tokens.The tokens can be found in the `user_external_accounts` table.
- Once we have the token we can check the scopes using this `curl`:
```
curl -I -H 'Authorization: token TOKEN' https://api.github.com/rate_limit
```

Then look at the line starting with `x-oauth-scopes` to see the list of granted scopes. We want to see both `repo` and `write:org` scopes as mentioned [here](https://docs.sourcegraph.com/admin/external_service/github#github-api-token-and-access) next to "Repository Permissions Caching". If the scopes are not what we want, we should ask the affected users to log out of Sourcegraph, [revoke the token](https://github.com/settings/applications) from GitHub, and try logging into Sourcegraph again using their GitHub details. It should prompt them for the correct scopes.

- In the logs we also noticed SG trying to clone a repo that does not exist both in code host and config file which we felt may be the cause, but restarting the repo updater cleared the error but not the stale permission.
 
### Resolution

On the call, we noticed they have explicit permission enabled. Which makes all other repository permissions mechanisms are disabled. The admin need to look into the history of why this was configured in the first place.
- They either need to enable permissions syncing on their instance or hit the explicit permissions API more often by setting permissions to allow users to view repositories.
- If they don't do it often, we'll alert that permissions are out of date
- In the repo updater we found Sourcegraph trying to clone a repo that does not exist in the code host or config file. Restarting the repo updater container solved that also.

### Relevant Docs Pages Used/Created
N/A
### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->

-  `259200s+ time gap between least and most up to date permissions for 5m0s`

- `100+ number of entities with stale permissions for 5m0s`

- This error shows that SG tries to update a repo which is not present in the database:`t=2022-06-02T00:05:15+0000 lvl=eror msg="runUpdateLoop: error updating repo" uri=[code.xxx.net/xxx/xxx](http://code.xxx.net/xxxx/xxxx) err="get VCS syncer: get repository: repo not found: name=\"[xxx.cxxxx.net/xxxx/xxxx](http://code.xxx.xxxx/xxxV/xxxxx)\`

<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 7877.md -->
