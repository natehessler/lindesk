
# malformed changeset spec ID <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#7293](https://sourcegraph.zendesk.com/agent/tickets/7293)
- Application engineer: Kelvin Lee
- Customer: Improbable <!-- Redact if this contains personally identifying information -->
- Date: Mar 31

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: ​3.32.1
- Deployment: kubernetes
- External Services: github
- Auth Providers: github, builtin


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: [Slack with customer](https://sourcegraph.slack.com/archives/C02LRB9SLQ5/p1648801894762839), and [RFH Ping, which has some useful info](https://sourcegraph.slack.com/archives/CMMTWQQ49/p1649293712778079) .
- GitHub Issue Link: [RFH](https://github.com/sourcegraph/customer/issues/812) , and then [public issue](https://github.com/sourcegraph/sourcegraph/issues/33619)
- Doc Update Link: None

## Summary
### Description of Customer Issue
Error being surfaced to UI on a Batch Changes page:  malformed changeset spec ID

Customer described that they were generating previews successfully via src batch preview. They were also able to visit the URL that is generated by src batch preview.

However, after selecting a changeset on the visited URL, and choosing "Publish on Apply", the aforementioned error would surface.

### Troubleshooting Steps
Things worth trying:
- `-clear-cache` flag seems to be a useful solution to attempt, that has been mentioned in [other resolved tickets](https://github.com/sourcegraph/support-tools-internal/search?q=%22-clear-cache%22) (example: [5419](https://github.com/sourcegraph/support-tools-internal/blob/6c786e038d615aa861a590d6e4508b18e7c88e5d/resolved-tickets/5419.md) ). It did not work here though.
- `src batch validate` command helps to validate the file that would be passed to the `src batch preview`. If a customer shares the entire `.yaml` with a support member, a support member should be able to run this for them. Or the customer can just run it themselves if, for some reason, they don't want to share the `.yaml` file. In this case, the customer's file passed the `src batch validate` check.
- Worth nothing that in the [RFH](https://github.com/sourcegraph/customer/issues/812#issuecomment-1092082709), that batch changes actually doesn't surface that many logs:

  > There's probably less logging than you'd expect here, in truth.

  The RFH continues to mention, though, that there is the `src batch preview -dump-requests`. Read along in the RFH for more information. In short: Logs might _not_ be a high-value vector of investigation for batch changes.


### Resolution
Ended up being a bug. The public issue was filed [here](https://github.com/sourcegraph/sourcegraph/issues/33619) . Note that, in the RFH + in the public issue, that this issue is not isolated to "Publish on Apply". Rather, the other dropdown actions would also generate the error("Publish draft on Apply", "Unpublish on Apply"). It's suggested in a comment of a [Slack thread](https://sourcegraph.slack.com/archives/CMMTWQQ49/p1649357929561129?thread_ts=1649293712.778079&cid=CMMTWQQ49) that this error might only generated if (a) there a batch change with more than 1 page of changesets and (b) the aforementioned action-menu flow is engaged with (i.e. choosing a dropdown action). The comment is quoted below:

> It’s definitely still there on main, so I assume it’s in 3.38. The key there might be that you need a batch spec that has more than a single page of changeset specs (which, practically, means more than 15) in order to trigger the two phase “select all” behaviour that’s buggy.

WORKAROUNDS, as shared in the RFH:
> I'm not quite sure what you mean by this, but I think there are probably (at least) two workarounds:
> - Apply the batch spec without setting the publication state, then use bulk actions on the batch change to set the publication state.
> - Set published: draft or published: true in the batch spec, and re-apply.



### Relevant Docs Pages Used/Created
None

### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->
`malformed changeset spec ID` <-- this is the generic message

```
* malformed changeset spec ID "a": illegal base64 data at input byte 0 * malformed changeset spec ID "l": illegal base64 data at input byte 0
```
This is the specific message. Note that the letters 'a' and 'l' are being sent. The discussions between the Slack and the RFH seem to suggest that this is the characters in the word "all" somehow being interpreted as a spec ID. The discussion seems to suggest it's coming from the "Select all" phrase, which can be found in the UI.

<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 7293.md -->
