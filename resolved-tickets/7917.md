
# Code Insights DB issue <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#7917](https://sourcegraph.zendesk.com/agent/tickets/7917)
- Application engineer: Gabe Torres
- Customer: Workiva <!-- Redact if this contains personally identifying information -->
- Date: Apr 28

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.35.1​
- Deployment: kubernetes
- External Services: GITHUB
- Auth Providers: builtin,github

## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/CTJUDV6JH/p1651184640306129 
- GitHub Issue Link: https://github.com/sourcegraph/customer/issues/733 
- Doc Update Link:

## Summary
### Description of Customer Issue
The customer switched codeintel-db and pgsql to managed databases and saw the following error in the frontend:  
`failed to initialize insights: Failed to connect to codeinsights database: DB not available: server refused TLS connection`

### Troubleshooting Steps
The customer is using PGSSLMODE: require for codeintel and pgsql and CODEINSIGHTS_PGSSLMODE: disable  
```
CODEINSIGHTS_PGDATASOURCE: postgres://postgres:password@codeinsights-db:5432/postgres
CODEINSIGHTS_PGSSLMODE: disable
```

### Resolution
Adding the long-form vars for codeinsights-db disables SSL for codeinsights-db.  
```
- CODEINSIGHTS_PGHOST=codeinsights-db
- CODEINSIGHTS_PGPORT=5432
- CODEINSIGHTS_PGUSER=postgres
- CODEINSIGHTS_PGPASSWORD=password
- CODEINSIGHTS_PGDATABASE=postgres
- CODEINSIGHTS_PGSSLMODE=disable
```


### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->
`failed to initialize insights: Failed to connect to codeinsights database: DB not available: server refused TLS connection.`


<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 7917.md -->
