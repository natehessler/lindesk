# Issue with dirty database during upgrade <!-- Ticket Title  Hint: include keywords to make it searchable -->
 
- Zendesk Link: [#4738](https://sourcegraph.zendesk.com/agent/tickets/4738)
- Application engineer: Michael Bali
- Customer: GOV.UK <!-- Redact if this contains personally identifying information -->
- Date: Nov 24

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->
 
## Technical Environment
- Version: 3.34.0â€‹
- Deployment: Kubernetes
- External Services: N/A
- Auth Providers: N/A
 
 
## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/C013FEJKFPX/p1637760377020900
- GitHub Issue Link: N/A
- Doc Update Link: N/A
 
## Summary
### Description of Customer Issue
Issue with dirty database during upgrade
 
### Troubleshooting Steps
- Shared documentation that explains the step to go through in resolving this.
- Customer ran into unique index creation errors because of duplicate values. 
 
### Resolution
The customer dropped and recreated the index and completed the troubleshooting steps in the doc and all the frontend pods are now back up.
 
### Relevant Docs Pages Used/Created
- https://sourcegraph.slack.com/archives/C02E4HE42BX/p1635460607076300?thread_ts=1635452729.068200&cid=C02E4HE42BX
- https://docs.sourcegraph.com/admin/how-to/dirty_database
 
### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->

```
sg=# SELECT * FROM schema_migrations;
  version   | dirty 
------------+-------
 1528395935 | t
(1 row)
```
```
sg=# CREATE INDEX CONCURRENTLY IF NOT EXISTS repo_stars_desc_id_desc_idx
sg-#     ON repo USING btree (stars DESC NULLS LAST, id DESC) WHERE deleted_at IS NULL AND blocked IS NULL;
NOTICE:  relation "repo_stars_desc_id_desc_idx" already exists, skipping
CREATE INDEX
sg=# \d repo
                                            Table "public.repo"
        Column         |           Type           | Collation | Nullable |             Default              
-----------------------+--------------------------+-----------+----------+----------------------------------
<snip>
Indexes:
<snip>
    "repo_stars_desc_id_desc_idx" btree (stars DESC NULLS LAST, id DESC) WHERE deleted_at IS NULL AND blocked IS NULL INVALID
```
<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 4738.md -->
