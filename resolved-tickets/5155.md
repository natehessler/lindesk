

# Repos not cloning <!-- Ticket Title  Hint: include keywords to make it searchable -->



- Zendesk Link: [#5155](https://sourcegraph.zendesk.com/agent/tickets/5155)

- Application engineer: Gabe Torres

- Customer: Capital One <!-- Redact if this contains personally identifying information -->

- Date: Dec 15


<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->

<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->



## Technical Environment

- Version: 3.31

- Deployment: ECS

- External Services:

- Auth Providers:





## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/C01QNMSLTFZ/p1639607711076500 

- GitHub Issue Link:

- Doc Update Link:



## Summary

### Description of Customer Issue
The customer reported that none of their repos were cloning. Their repos were showing "Repository does not exist" and they were stuck under "Not cloned".



### Troubleshooting Steps
The customer saw "repository does not exist" errors in the worker logs. These errors are expected on their empty or archived repos so this error was a misleading clue.
We cloned a repo inside of their gitserver container to make sure there was no issues communicating with GitHub.
The code host config did not show any errors so it seemed to be correct.
We checked the grafana dash for repo updater and we saw a lot of repos stalling. "Rate of growth of update queue length over 5 minutes" showed that there was a backup of repos in the queue. 
The "remaining API calls to GitHub" graph also showed that they were running out of API calls but they were using a new token.
The admin set the log level to debug SRC_LOG_LEVEL=dbug. This showed the following error in repo-updater "not cloning on demand as DisableAutoGitUpdates is set"


### Resolution
We found out that the admin had copied their site config from another instance where they were restricting communication to GitHub by using 
```
"disableAutoGitUpdates": true,
"disableAutoCodeHostSyncs": true,
"gitMaxCodehostRequestsPerSecond": 0,
```

After removing these settings they were able to see the repos cloning.


### Relevant Error / Logs

<!-- Please redact keys, tokens, and personal identifying information -->
`lvl=eror msg="error fetching commits from gitserver repo_id: 25: git command [git log --format=format:%H%x00%x00%aN%x00%aE%x00%at%x00%cN%x00%cE%x00%ct%x00%B%x00%P%x00 --after=2020-12-15T16:49:50Z --date-order] failed (output: \"\"): repository does not exist`

`t=2021-12-17T16:53:26+0000 lvl=dbug msg="error starting repo clone" repo=github.com/repo err="rate: Wait(n=1) exceeds limiter's burst 0"`

`t=2021-12-17T16:46:47+0000 lvl=dbug msg="not cloning on demand as DisableAutoGitUpdates is set"`


<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 5155.md -->
