
# New Slack message in support-indeed-campaigns <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#7307](https://sourcegraph.zendesk.com/agent/tickets/7307)
- Application engineer: Quinlan Sparks
- Customer: Indeed <!-- Redact if this contains personally identifying information -->
- Date: Apr 1

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: 3.33.2​
- Deployment: kubernetes
- External Services: GITLAB
- Auth Providers: saml


## Links
<!-- Data for application engineer manual entry -->
- Slack Links: https://sourcegraph.slack.com/archives/C01EDKVG9J5/p1648834474409439
- GitHub Issue Link:
- Doc Update Link:

## Summary
### Customer Question
The customer was attempting to run a Batch Change with the following spec:
```yaml
name: OSST-1709-replace-cypress-axe-fork
description: &batch_change_description |
   The [fork](https://code.corp.indeed.com/deg-accessibility/cypress-axe) of [cypress-axe](https://github.com/component-driven/cypress-axe)
   is now [abandoned](https://code.corp.indeed.com/deg-accessibility/cypress-axe/-/commit/87dc3a5309d55b65f119cc674cf59dd22bbc6b6e).
   You should upgrade to the upstream version.
on:
 - repository: code.corp.indeed.com/api-platforms/one-graph-sample-mosaic-nodejs-client
steps:
 - run: |
     # skip MOSAIC onboarding (hangs on user prompts)
     export MOSAIC_CONTEXT=test
     # workaround node-git-version failing (in postinstall) because not using a clone
     git init
     touch dummy_file
     git add dummy_file
     git commit -m 'dummy commit'
     git remote add origin git@code.corp.indeed.com:dummy/repo.git
     find . -type f -name package.json -not -path "*/node_modules/*" -print0 | while read -r -d $'\0' packageFile; do
       directory=$(dirname "${packageFile}")
       cd "${directory}" || exit 1
       nvm install
       nvm use
       devDep=0
       if [ $(jq '.dependencies["@indeed/cypress-axe"]' package.json) = 'null' ]; then
         devDep=1
       fi
       npm uninstall @indeed/cypress-axe
       if [ ${devDep} -gt 0 ]; then
         npm install --save-dev cypress-axe@latest
       else
         npm install --save-prod cypress-axe@latest
       fi
       # clean up (SourceGraph runs `git add --force --all`)
       rm --recursive --force node_modules/
       cd - || exit 1
     done
     # clean up workaround for node-git-version failing
     rm --recursive .git
     rm dummy_file
   container: registry.corp.indeed.com/build-images/docker-build-environment-base/docker-build-environment-base-centos7:latest-stable
changesetTemplate:
 title: &changeset_title "chore(deps): Replace Indeed fork of cypress-axe with upstream"
 body: *batch_change_description
 branch: jira/OSST-1709__replace-cypress-axe_fork
 commit:
   message: *changeset_title
   author:
     name: Keegan Witt
     email: kwitt@indeed.com
 published: true
```

They interpreted the following log output as an indication that it should have succeeded, and were confused about why their resulting changesets were empty:
```md
2022-04-01T13:32:53.751099-04:00 stdout | /work
2022-04-01T13:32:53.751131-04:00 stdout |
2022-04-01T13:32:56.558915-04:00 [Step 1] complete in 14m29.162s
```

### Application Engineer Answer
The original YAML was structured to include a workaround for an internal package that runs after any `npm install`, which was built under the assumption that it would be run from within a clone, and not an archived version of the code in a new git repo. The customer misinterpreted the order of operations in the explanation of how `src` executes a batch spec, but was able to quickly create a new workaround that functions as expected once I pointed out the discrepancy.

### Relevant Docs Pages Used/Created
https://docs.sourcegraph.com/batch_changes/explanations/how_src_executes_a_batch_spec#1-download-archive-and-prepare

<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 7307.md -->
