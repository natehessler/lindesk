
# Sourcegraph Helm Installation via Azure AKS Cluster <!-- Ticket Title  Hint: include keywords to make it searchable -->

- Zendesk Link: [#9457](https://sourcegraph.zendesk.com/agent/tickets/9457)
- Application engineer: Michael Bali
- Customer: <!-- Redact if this contains personally identifying information -->
- Date: June 30, 2022

<!-- Data populated from integration, speak to Ben Gordon or Michael Bali if not working -->
<!-- During Internal team trial, fill missing data manually (we are waiting for all data to sync) -->

## Technical Environment
- Version: ​N/A
- Deployment: N/A
- External Services: N/A
- Auth Providers: N/A


## Links
<!-- Data for application engineer manual entry -->
- Slack Links:
- GitHub Issue Link:
- Doc Update Link:

## Summary
### Description of Customer Issue
- The Admin is getting a 502 Bad Gateway error when trying to access the SG UI.
- The access to the Sourcegraph instance is not secured even though I am using a Digicert signed certificate. Have you had any experience with using a pem file instead of a crt file for the Kubernetes TLS secret? I am wondering if that is the issue or if it shouldn’t cause a problem.
- When I first accessed the Sourcegraph instance, I was directed to create an email, username, and password but when I tried to log in again I wouldn’t be directed to my site admin account and it wouldn’t show an incorrect username/password prompt. I checked all of the pods, storage, and services and everything seems to be fine so I’m curious what could be causing this issue.


### Troubleshooting Steps
- Are all your pods healthy, and do you see any restarts? – Yes all pods are healthy
- Are there any visible errors in the Sourcegraph UI? – Sourcegraph UI does not show up when I try to reach our DNS, currently 502 Bad Gateway.
- Are you able to perform a code search in the UI and get results? – See Above
- Can I have a copy of both your site admin and code host config? See above
- Can I get a `describe `of both the frontend and Postgres pod?
- I would like us to test if you're able to access Sourcegraph without the ingress. Try running:
`kubectl port-forward service/sourcegraph-frontend -n sourcegraph 30080:30080` and access localhost:30080 in your browser. If it loads correctly, then the problem seems to be in the ingress layer.

### Resolution
- The documentation was very helpful and I was able to configure the helm chart to specify the tls-secret I created that contains a pem file and key which allows me to connect to the SG UI at Sourcegraph-test.azure.chevron.com. The port forward command you recommended also allowed me to access the UI successfully which means that the network configuration was the issue.

- To enable SSL for the SG instance: I was missing some of the configurations on the application gateway to define the correct pfx cert and password, backend pool to reflect the endpoint of the Sourcegraph-frontend, and backend settings to reflect the correct port 3080.

- The issue with the SG log on was caused by the application gateway’s Web application firewall picking up false positives when I tried to log in. Not sure why they were considered malicious, but I will look further into that.

### Relevant Docs Pages Used/Created
- https://docs.microsoft.com/en-us/azure/application-gateway/ingress-controller-expose-service-over-http-https
- https://docs.sourcegraph.com/admin/deploy/kubernetes/helm#configure-sourcegraph-on-azure-managed-kubernetes-service-aks
- https://docs.sourcegraph.com/admin/how-to/setup-https

### Relevant Error / Logs
<!-- Please redact keys, tokens, and personal identifying information -->


<!-- Once complete, upload a copy to https://github.com/sourcegraph/support-tools-internal/tree/main/resolved-tickets as a .md file -->
<!-- Name the file 9457.md -->
