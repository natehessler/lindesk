zendeskTicketNumber: 8903
zendeskLink: https://sourcegraph.zendesk.com/agent/tickets/8903
title: Sourcegraph 3.39 caddy-2.4.6-alpine vulnerabilities
Application engineer: Stomzy Mwendwa
Customer: bet365 
Date: June 10, 2022
Version: 3.38.0
Deployment: docker-compose
External Services: GITLAB
Auth Providers: gitlab,gitlab
Slack Links: N/A
GitHub Issue Link: N/A
Doc Update Link: N/A
Summary: Hi Sourcegraph.
In the process of upgrading to v3.39 our information security department have concerns over the caddy-2.4.6-alpine docker image used in the product:
https://github.com/sourcegraph/deploy-sourcegraph-docker/blob/3.39/docker-compose/docker-compose.yaml
We found the following vulnerabilities:
Summary
CVEs
Severity
CVSS v3
An attacker-controlled pointer free in Busybox's hush applet leads to denial of service and possible code execution when processing a crafted shell command, due to the shell mishandling the &&& string. This may be used for remote code execution under rare conditions of filtered command input.
CVE-2021-42377
Critical
9.8
In musl libc through 1.2.1, wcsnrtombs mishandles particular combinations of destination buffer size and source character limit, as demonstrated by an invalid write access (buffer overflow).
CVE-2020-28928
Medium
5.5
Please could you advise if a newer version could be used, or if there are ways to mitigate the critical vulnerability?
Hi folks,
Just a follow up question. I believe, please correct me if I'm wrong, that you have a load balancer in place.
The reason I ask is because if you do have a LB then we can safely ignore this caddy image and remove it entirely. Basically we can route the LB to the frontend port instead.
Hi Phil, Hi Chris,
Thanks for your patience. I meant to send you a reply on Friday evening and I totally forgot to hit send. My apologies for that.
We can certainly look into this, could you please supply more details how this would be achieved i.e.Â the docker changes and the TCP port change for the Load Balancer?
Sure. More than happy to share how to go about this.
There's actually two options here that we could explore here.
Option 1 We can remove the caddy container and swap out with nginx for which we already have the configuration for in our docker-compose repo here. The only blocker here is that I unfortunately can't seem to find the configuration to match this.
Option 2(which I think makes more sense)
Caddy is configured on L79 to speak to the frontend on port 3080. We could remove caddy entirely and avoid using nginx and route the LB to the fronted port (3080) whilst avoiding making changes to the compose file, I'd suggest perhaps making the port change on the LB directly and exposing 3080 to the frontend and bypass caddy altogether.
I hope this makes sense in a way.
https://sourcegraph.slack.com/archives/C01D50MSA7L/p1653377636420459
