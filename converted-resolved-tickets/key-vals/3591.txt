zendeskTicketNumber: 3591
zendeskLink: https://sourcegraph.zendesk.com/agent/tickets/3591
title: Lyft - Slack - 3.29.0 -\> 3.30.4 problems
CSE: Gabe Torres
Customer: Lyft, Inc. 
Date: 28 October 2021
Version: 3.30.4​
Deployment: kubernetes
External Services: GITHUB
Auth Providers: saml
Slack Links: https://sourcegraph.slack.com/archives/C0174NVAREV/p1632868259016100
GitHub Issue Link: NA
Doc Update Link: NA
Summary: After upgrading from 3.29.0 to 3.30.4 the customer reported that the pgsql container was in a crashloopbackoff.
The error message (in Relevant Error) from the events on the container gave us a good clue that Postgres was refusing new connections because the connection limit was reached. 
https://github.com/sourcegraph/deploy-sourcegraph/blob/master/base/pgsql/pgsql.ConfigMap.yaml
https://docs.sourcegraph.com/admin/config/postgres-conf
Increasing the max_connections to 300 stabilized their instance.
    Normal   Pulled                  13m                     kubelet                  Container image "sourcegraph/postgres-12.6:3.30.4" already present on machine
    Normal   Created                 13m (x2 over 14m)       kubelet                  Created container pgsql
    Warning  Unhealthy               12m (x5 over 13m)       kubelet                  Liveness probe failed: psql: error: FATAL:  sorry, too many clients already
    Warning  Unhealthy               8m39s (x20 over 13m)    kubelet                  Readiness probe failed: psql: error: FATAL:  sorry, too many clients already
    Warning  BackOff                 4m14s (x10 over 5m56s)  kubelet                  Back-off restarting failed container
