-   Application engineer: Warren Gifford
-   Customer: Apple 
-   Date: May 17, 2022
-   Version: 3.32.0​
-   Deployment: docker-container
-   External Services: OTHER
-   Auth Providers: saml
-   Slack Links: https://sourcegraph.slack.com/archives/C0225J36ZTR/p1652841688760229
-   GitHub Issue Link: https://github.com/sourcegraph/customer/issues/991
-   Doc Update Link:
Upgrade of a single container docker image running in a k8s cluster fails due to code-insights db initializing incorrectly
warrengifford@Warrens-MacBook-Pro \~ % docker run -d --publish 7080:7080 --publish 127.0.0.1:3370:3370 -e ALLOW_SINGLE_DOCKER_CODE_INSIGHTS=false --rm --volume \~/.sourcegraph/config:/etc/sourcegraph --volume \~/.sourcegraph/data:/var/opt/sourcegraph sourcegraph/server:3.38.0 24b2dfeb29e730145d4593aeea40295dbea01fcc5a6d879687f45ea469d5836e warrengifford@Warrens-MacBook-Pro \~ % docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 24b2dfeb29e7 sourcegraph/server:3.38.0 "/sbin/tini -- /usr/..." 4 seconds ago Up 4 seconds 127.0.0.1:3370-\>3370/tcp, 0.0.0.0:7080-\>7080/tcp jovial_booth warrengifford@Warrens-MacBook-Pro \~ % docker container exec -it 24b2dfeb29e7 sh -c 'env' HOSTNAME=24b2dfeb29e7 ALLOW_SINGLE_DOCKER_CODE_INSIGHTS=false SHLVL=1 HOME=/root TERM=xterm GO111MODULES=on PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin LANG=en_US.utf8 PWD=/ MINIO_VERSION=RELEASE.2021-12-10T23-03-39Z warrengifford@Warrens-MacBook-Pro \~ % docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 24b2dfeb29e7 sourcegraph/server:3.38.0 "/sbin/tini -- /usr/..." 4 minutes ago Up 4 minutes 127.0.0.1:3370-\>3370/tcp, 0.0.0.0:7080-\>7080/tcp jovial_booth warrengifford@Warrens-MacBook-Pro \~ % docker kill 24b2dfeb29e7 24b2dfeb29e7 warrengifford@Warrens-MacBook-Pro \~ % docker run -d --publish 7080:7080 --publish 127.0.0.1:3370:3370 -e ALLOW_SINGLE_DOCKER_CODE_INSIGHTS=false --rm --volume \~/.sourcegraph/config:/etc/sourcegraph --volume \~/.sourcegraph/data:/var/opt/sourcegraph sourcegraph/server:3.39.0 e959da140eabac870af7687a71bc0c8865016eb3e695de1b2546453f023f6725 warrengifford@Warrens-MacBook-Pro \~ % docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES e959da140eab sourcegraph/server:3.39.0 "/sbin/tini -- /usr/..." 7 seconds ago Up 6 seconds 127.0.0.1:3370-\>3370/tcp, 0.0.0.0:7080-\>7080/tcp crazy_goodall warrengifford@Warrens-MacBook-Pro \~ % docker logs e959da140eab ✱ Sourcegraph is creating missing databases sourcegraph-codeinsights... (may take 15-20 seconds) ✱ Finished initializing the internal database. Starting postgres processes Starting migrator 03:15:48 postgres \
...
warrengifford@Warrens-MacBook-Pro \~ % docker exec -it e959da140eab sh -c 'env' HOSTNAME=e959da140eab ALLOW_SINGLE_DOCKER_CODE_INSIGHTS=false SHLVL=1 HOME=/root TERM=xterm GO111MODULES=on PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin LANG=en_US.utf8 PWD=/ MINIO_VERSION=RELEASE.2021-12-10T23-03-39Z
This was tested extensively and eventually the customer was advised to set up a volume to pipe the failing postgres container logs too Hey @Maray Elammari I've attempted a number of tests to reproduce this issue on test instances via a docker-compose style deployment of the Sourcegraph server. I'll continue trying, but also it would be good if we could attempt to get the postgres logs from the failing codeingishts_db initializationCould you create a volume mount in your compose file so that we can persist those logs?On the host machine -- mkdir \~/.sourcegraph/tmp chmod 1777 \~/.sourcegraph/tmp
Then in your compose file, add the following volume mount volumes: - \~/.sourcegraph/tmp:/tmp
If you try to upgrade again and it fails we should be able to take a look at the db failure logs there. Let me know if you try this out or if you try out the fake env var from above
\[codestage@code-search-app tmp\]\$ sudo more pgsql.log 2022-06-08 16:59:00.172 UTC \[24\] LOG: starting PostgreSQL 12.10 on x86_64-alpine-linux-musl, compiled by gcc (Alpine 9.3.0) 9.3.0, 64-bit 2022-06-08 16:59:00.172 UTC \[24\] LOG: could not bind IPv4 address "127.0.0.1": Permission denied 2022-06-08 16:59:00.172 UTC \[24\] HINT: Is another postmaster already running on port 443? If not, wait a few seconds and retry. 2022-06-08 16:59:00.172 UTC \[24\] WARNING: could not create listen socket for "127.0.0.1" 2022-06-08 16:59:00.172 UTC \[24\] FATAL: could not create any TCP/IP sockets 2022-06-08 16:59:00.172 UTC \[24\] LOG: database system is shut down
This issue was resolved with a PR that prevents the db from initializing in single container deployments https://github.com/sourcegraph/sourcegraph/issues/36746
