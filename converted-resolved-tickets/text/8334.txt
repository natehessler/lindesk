-   Application engineer: Warren Gifford
-   Customer: Reddit 
-   Date: May 19, 2022
-   Version: 3.36.2​
-   Deployment: kubernetes
-   External Services: GITHUB
-   Auth Providers: builtin,github
-   Slack Links:
-   GitHub Issue Link:
-   Doc Update Link:
Reddit was receiving an alert for repo-updater: 1+ repos that haven't been fetched in more than 8 hours for 25m0s
To determine the source of the error the database was queries to find the repos that weren't synching SELECT repo.name, gitserver_repos.last_error FROM gitserver_repos JOIN repo ON repo.id=gitserver_repos.repo_id  WHERE last_error != '' AND repo.name NOT LIKE 'DELETED%';
From the returned list it was determined that these repos had been removed from the codehost, but that repo-updater was failing to update their status in the database there is no unique or exclusion constraint matching the ON CONFLICT specification (SQLSTATE 42P10)
This issue was resolved after identifying that during a previous incident in which the database schema had been corrupted during an upgrade (see here https://github.com/sourcegraph/customer/issues/950), however a schema constraint was missed
The following SQL query was used to alter the schema issue ALTER TABLE external_service_repos DROP CONSTRAINT external_service_repos_repo_id_external_service_id_unique; ALTER TABLE external_service_repos ADD CONSTRAINT external_service_repos_repo_id_external_service_id_unique UNIQUE (repo_id, external_service_id);
After this we did some follow up to verify there were no other schema issues by use of the migrator drift command -- learn more here: https://github.com/sourcegraph/sourcegraph/issues/36973
