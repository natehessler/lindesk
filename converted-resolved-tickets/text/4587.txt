-   Application engineer: Michael Bali
-   Customer: Reddit 
-   Date: Nov 15, 2021
-   Version: 3.32.0â€‹
-   Deployment: kubernetes
-   External Services: GITHUB
-   Auth Providers: builtin,GitHub
-   Slack Links: https://sourcegraph.slack.com/archives/C02BJ8T258D/p1637018351137800
-   GitHub Issue Link: https://github.com/sourcegraph/customer/issues/582
-   Doc Update Link: N/A
The customer set up an entire second Sourcegraph install in the same cluster as the existing install. The new install is intended to be their production instances. The issue the customer was having is that both installations are picking up each other's metrics and she would like to know if there is a way to have each Prometheus scrape only metrics for its namespace.
-   I tried to find out what cadvisor config does.
-   Basically what the customer is trying to achieve is called a multi-tenant cluster - We generally recommend against deploying Sourcegraph in a multi-tenant Kubernetes cluster as that increases the risks that Sourcegraph and your other services could run into resource constraints imposed by the other because the cadvisor is a deamonset and cannot be changed to a deployment.cadvisor is an official Google tool for collecting metrics such as CPU/memory/IO from the host node of Kubernetes clusters. It is required to be run as a daemonset because only one copy of it should run per host node, it cannot be a deployment by nature of what it does. It needs to run on every node that SG runs on in order for us to get the correct metrics. cAdvisor exports all of our metrics to Prometheus and Grafana.
-   Ensure that both SG instances are properly configured to use their distinct namespaces by using a namespace overlay for sourcegraph. - We have some docs on this here: https://docs.sourcegraph.com/admin/install/kubernetes/overlays
-   check the metric_relabel_configs section in each instance configmap file in the Prometheus folder. uncommenting those 3 lines ensure that metrics for namespace A are kept.
-   Run the command to see namespaces in the cluster. (kubectl get pods --namespace=prod -o=wide)
-   check to see that metrics are now configured properly.
-   https://docs.sourcegraph.com/admin/install/kubernetes/configure
-   https://docs.sourcegraph.com/dev/background-information/observability/cadvisor
N/A
